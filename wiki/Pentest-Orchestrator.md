# Pentest Orchestrator

Orchestrateur de tests de pénétration intégrant plusieurs outils de scan.

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                    Pentest Orchestrator                      │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                   Plugin Manager                     │    │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐   │    │
│  │  │  ZAP    │ │ Nuclei  │ │ Masscan │ │  Burp   │   │    │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘   │    │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐               │    │
│  │  │Metasploit│ │ VulnX   │ │ Faraday │               │    │
│  │  └─────────┘ └─────────┘ └─────────┘               │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
                           │
                           ▼
                    ┌─────────────┐
                    │   Faraday   │
                    │ (Résultats) │
                    └─────────────┘
```

## Emplacement

```
/opt/bojemoi/samsonov/pentest_orchestrator/
├── main.py                 # Orchestrateur principal
├── import_results.py       # Import des résultats vers Faraday
├── plugins/
│   ├── plugin_faraday.py   # Client Faraday
│   ├── plugin_nuclei.py    # Scanner Nuclei
│   ├── plugin_zap.py       # OWASP ZAP
│   ├── plugin_masscan.py   # Scanner de ports
│   ├── plugin_burp.py      # Burp Suite
│   ├── plugin_metasploit.py# Metasploit Framework
│   └── plugin_vulnx.py     # VulnX CMS scanner
├── config/
│   └── config.json         # Configuration
└── results/                # Résultats des scans
```

## Types de Scans

| Type | Description | Outils utilisés |
|------|-------------|-----------------|
| `full` | Scan complet | Masscan, ZAP, Burp, Nuclei, VulnX, Metasploit |
| `web` | Applications web | ZAP, Burp, Nuclei, VulnX |
| `network` | Infrastructure réseau | Masscan, Metasploit, Nuclei |
| `vuln` | Vulnérabilités | Nuclei, VulnX |
| `cms` | CMS (WordPress, Joomla) | VulnX, Nuclei |

## Utilisation

### Mode CLI
```bash
cd /opt/bojemoi/samsonov/pentest_orchestrator

# Scan complet
python3 main.py -t 192.168.1.1 -s full -w mon_workspace

# Scan web
python3 main.py -t https://example.com -s web

# Voir le statut
python3 main.py --status

# Lister les fonctions
python3 main.py --list
```

### Mode Daemon (Redis)
```bash
# Démarrer en mode daemon
python3 main.py --daemon

# Envoyer une commande via Redis
redis-cli PUBLISH pentest:commands '{"action": "scan", "target": "192.168.1.1", "type": "full"}'
redis-cli PUBLISH pentest:commands '{"action": "status"}'
redis-cli PUBLISH pentest:commands '{"action": "reload"}'
```

### Via Claude Code
```
/pentest status    # Voir le statut
/pentest plugins   # Lister les plugins
/pentest results   # Voir les résultats
```

## Import des Résultats

Les résultats sont automatiquement envoyés à Faraday après chaque scan. Pour importer manuellement:

```bash
cd /opt/bojemoi/samsonov/pentest_orchestrator

# Voir les fichiers en attente
python3 import_results.py --list

# Dry run
python3 import_results.py --dry-run

# Importer
python3 import_results.py

# Importer vers un workspace spécifique
python3 import_results.py -w mon_workspace

# Réimporter les fichiers déjà importés
python3 import_results.py --include-imported
```

## Configuration

### config/config.json
```json
{
  "faraday": {
    "url": "http://faraday:5985",
    "username": "faraday",
    "password": "changeme"
  },
  "nuclei": {
    "templates_path": "/nuclei-templates"
  },
  "zap": {
    "api_url": "http://zap:8080",
    "api_key": ""
  }
}
```

### Variables d'environnement
```bash
FARADAY_URL=http://faraday:5985
FARADAY_USERNAME=faraday
FARADAY_PASSWORD=changeme
REDIS_HOST=redis
REDIS_PORT=6379
```

## Plugins

### plugin_faraday.py
- `import_results(workspace, results)` - Importe les résultats
- `get_status()` - Vérifie la connexion
- `list_workspaces()` - Liste les workspaces
- `create_workspace(name)` - Crée un workspace

### plugin_nuclei.py
- `quick_scan(target)` - Scan rapide
- `full_scan(target)` - Scan complet
- `cve_scan(target)` - Scan CVE
- `technology_scan(target)` - Détection de technologies

### plugin_zap.py
- `spider_scan(target)` - Crawl du site
- `active_scan(target)` - Scan actif
- `get_alerts(target)` - Récupère les alertes

### plugin_masscan.py
- `quick_scan(target)` - Scan ports communs
- `full_scan(target)` - Scan tous les ports

## Commandes Redis (Mode Daemon)

### Pourquoi Redis ?

```
┌────────────┐                 ┌───────────┐                 ┌──────────────┐
│  Clients   │    PUBLISH      │   Redis   │    Subscribe    │ Orchestrator │
│ (multiples)│───────────────▶ │           │ ───────────────▶│   (daemon)   │
└────────────┘  pentest:commands└───────────┘                 └──────┬───────┘
                                     ▲                               │
                                     │ pentest:results               │
                                     └───────────────────────────────┘
```

- **Découplage** : Les clients n'ont pas besoin de connaître l'adresse de l'orchestrateur
- **Asynchrone** : Pas d'attente (les scans peuvent durer des heures)
- **Résilience** : Reconnexion automatique si l'orchestrateur redémarre
- **Scalabilité** : Plusieurs orchestrateurs peuvent écouter le même channel

### Format des commandes

Toutes les commandes sont en JSON sur le channel `pentest:commands` :

```json
{"action": "<action>", "target": "<cible>", "type": "<type_scan>"}
```

### Commandes disponibles

| Action | Description | Exemple |
|--------|-------------|---------|
| `scan` | Lance un scan | `{"action": "scan", "target": "192.168.1.1", "type": "full"}` |
| `status` | Affiche le statut | `{"action": "status"}` |
| `list` | Liste les fonctions | `{"action": "list"}` |
| `reload` | Recharge les plugins | `{"action": "reload"}` |

### Exemples avec redis-cli

```bash
# Scan complet d'une IP
redis-cli PUBLISH pentest:commands '{"action": "scan", "target": "192.168.1.1", "type": "full"}'

# Scan web d'une URL
redis-cli PUBLISH pentest:commands '{"action": "scan", "target": "https://example.com", "type": "web"}'

# Scan réseau d'un subnet
redis-cli PUBLISH pentest:commands '{"action": "scan", "target": "10.0.0.0/24", "type": "network"}'

# Scan CMS
redis-cli PUBLISH pentest:commands '{"action": "scan", "target": "https://wordpress.local", "type": "cms"}'

# Vérifier le statut
redis-cli PUBLISH pentest:commands '{"action": "status"}'

# Recharger les plugins après modification
redis-cli PUBLISH pentest:commands '{"action": "reload"}'
```

### Écouter les résultats

```bash
# Terminal séparé - écoute les résultats
redis-cli SUBSCRIBE pentest:results
```

### Exemple Python

```python
import redis
import json

r = redis.Redis(host='redis', port=6379)

# Envoyer une commande
command = {
    "action": "scan",
    "target": "192.168.1.0/24",
    "type": "network"
}
r.publish('pentest:commands', json.dumps(command))

# Écouter les résultats
pubsub = r.pubsub()
pubsub.subscribe('pentest:results')

for message in pubsub.listen():
    if message['type'] == 'message':
        result = json.loads(message['data'])
        print(f"Scan terminé: session={result['session_id']}, target={result['target']}")
```

### Depuis Docker

```bash
# Si Redis est dans le swarm
docker exec -it $(docker ps -q -f name=redis) redis-cli PUBLISH pentest:commands '{"action": "scan", "target": "10.0.0.1", "type": "vuln"}'
```

## Logs

Les logs sont écrits dans `orchestrator.log` :

```bash
tail -f /opt/bojemoi/samsonov/pentest_orchestrator/orchestrator.log
```

## Voir aussi

- [[Faraday]] - Gestion des vulnérabilités
- [[Alertes]] - Alertes Prometheus
