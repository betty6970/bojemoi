# Configuration du pipeline Logstash
input {
  # Écoute des logs via syslog
  syslog {
    port => 514
    type => "syslog"
  }
  
  # Écoute des logs via beats (Filebeat, etc.)
  beats {
    port => 5044
    type => "beats"
  }
  
  # Écoute des logs JSON via TCP
  tcp {
    port => 5000
    codec => json_lines
    type => "json"
  }
  
  # Lecture de fichiers de logs
  file {
    path => "/var/log/docker/containers/*/*.log"
    start_position => "beginning"
    type => "docker"
    codec => "json"
  }
}

filter {
  # Traitement des logs Docker
  if [type] == "docker" {
    json {
      source => "message"
    }
    
    # Extraction du nom du conteneur
    if [attrs][name] {
      mutate {
        add_field => { "container_name" => "%{[attrs][name]}" }
      }
    }
    
    # Parsing des timestamps
    date {
      match => [ "time", "ISO8601" ]
    }
  }
  
  # Traitement des logs syslog
  if [type] == "syslog" {
    grok {
      match => { 
        "message" => "%{SYSLOGTIMESTAMP:timestamp} %{IPORHOST:host} %{PROG:program}(?:\[%{POSINT:pid}\])?: %{GREEDYDATA:log_message}"
      }
    }
    
    date {
      match => [ "timestamp", "MMM dd HH:mm:ss" ]
    }
  }
  
  # Traitement des logs avec niveau (ERROR, WARN, INFO, etc.)
  grok {
    match => { 
      "message" => "(?<log_level>ERROR|WARN|INFO|DEBUG|TRACE)"
    }
    tag_on_failure => ["_grokparsefailure_loglevel"]
  }
  
  # Ajout de métadonnées
  mutate {
    add_field => { 
      "[@metadata][index_prefix]" => "logstash"
      "environment" => "production"
    }
    
    # Nettoyage des champs inutiles
    remove_field => ["attrs", "ecs", "agent", "input", "host"]
  }
  
  # Filtrage des messages vides
  if [message] == "" or [message] == "-" {
    drop {}
  }
}

output {
  # Envoi vers Elasticsearch
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "logstash-%{+YYYY.MM.dd}"
    template_name => "logstash"
    template_pattern => "logstash-*"
    manage_template => true
  }
  
  # Envoi vers Loki (optionnel)
  loki {
    url => "http://loki:3100"
    tenant_id => "logstash"
  }
  
  # Sortie de debug (à désactiver en production)
  stdout {
    codec => rubydebug
  }
}
