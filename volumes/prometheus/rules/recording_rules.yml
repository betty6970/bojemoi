# =============================================================================
# Recording Rules - Agrégations pour Docker Swarm
# Fichier: /etc/prometheus/rules/recording_rules.yml
# =============================================================================

groups:
  # ---------------------------------------------------------------------------
  # Node-level aggregations
  # ---------------------------------------------------------------------------
  - name: node_aggregations
    interval: 30s
    rules:
      # CPU usage par nœud (%)
      - record: swarm:node:cpu_usage_percent
        expr: |
          100 - (
            avg by (instance, node_role) (
              irate(node_cpu_seconds_total{mode="idle"}[5m])
            ) * 100
          )

      # CPU usage par mode
      - record: swarm:node:cpu_by_mode
        expr: |
          sum by (instance, mode) (
            irate(node_cpu_seconds_total[5m])
          )

      # Mémoire utilisée (%)
      - record: swarm:node:memory_usage_percent
        expr: |
          100 - (
            (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes) * 100
          )

      # Mémoire disponible (Go)
      - record: swarm:node:memory_available_gb
        expr: node_memory_MemAvailable_bytes / 1024 / 1024 / 1024

      # Swap utilisé (%)
      - record: swarm:node:swap_usage_percent
        expr: |
          (
            (node_memory_SwapTotal_bytes - node_memory_SwapFree_bytes) 
            / node_memory_SwapTotal_bytes
          ) * 100

      # Disk usage par mountpoint (%)
      - record: swarm:node:disk_usage_percent
        expr: |
          100 - (
            (node_filesystem_avail_bytes{fstype!~"tmpfs|fuse.*"} 
             / node_filesystem_size_bytes{fstype!~"tmpfs|fuse.*"}) * 100
          )

      # Disk IO read rate (MB/s)
      - record: swarm:node:disk_read_mb_per_sec
        expr: |
          sum by (instance, device) (
            irate(node_disk_read_bytes_total[5m])
          ) / 1024 / 1024

      # Disk IO write rate (MB/s)
      - record: swarm:node:disk_write_mb_per_sec
        expr: |
          sum by (instance, device) (
            irate(node_disk_written_bytes_total[5m])
          ) / 1024 / 1024

      # Network receive rate (Mbps)
      - record: swarm:node:network_receive_mbps
        expr: |
          sum by (instance, device) (
            irate(node_network_receive_bytes_total{device!~"lo|veth.*|docker.*"}[5m])
          ) * 8 / 1024 / 1024

      # Network transmit rate (Mbps)
      - record: swarm:node:network_transmit_mbps
        expr: |
          sum by (instance, device) (
            irate(node_network_transmit_bytes_total{device!~"lo|veth.*|docker.*"}[5m])
          ) * 8 / 1024 / 1024

      # Load average 1m
      - record: swarm:node:load1
        expr: node_load1

      # Load average 5m
      - record: swarm:node:load5
        expr: node_load5

      # Uptime (jours)
      - record: swarm:node:uptime_days
        expr: (time() - node_boot_time_seconds) / 86400

  # ---------------------------------------------------------------------------
  # Cluster-level aggregations
  # ---------------------------------------------------------------------------
  - name: cluster_aggregations
    interval: 30s
    rules:
      # Nombre total de nœuds
      - record: swarm:cluster:nodes_total
        expr: count(swarm:node:cpu_usage_percent)

      # Nombre de nœuds managers
      - record: swarm:cluster:managers_total
        expr: count(swarm:node:cpu_usage_percent{node_role="manager"})

      # Nombre de nœuds workers
      - record: swarm:cluster:workers_total
        expr: count(swarm:node:cpu_usage_percent{node_role="worker"})

      # CPU moyen du cluster (%)
      - record: swarm:cluster:cpu_usage_percent_avg
        expr: avg(swarm:node:cpu_usage_percent)

      # CPU max du cluster (%)
      - record: swarm:cluster:cpu_usage_percent_max
        expr: max(swarm:node:cpu_usage_percent)

      # Mémoire moyenne du cluster (%)
      - record: swarm:cluster:memory_usage_percent_avg
        expr: avg(swarm:node:memory_usage_percent)

      # Mémoire max du cluster (%)
      - record: swarm:cluster:memory_usage_percent_max
        expr: max(swarm:node:memory_usage_percent)

      # Mémoire totale disponible (Go)
      - record: swarm:cluster:memory_total_gb
        expr: sum(node_memory_MemTotal_bytes) / 1024 / 1024 / 1024

      # Espace disque total (To)
      - record: swarm:cluster:disk_total_tb
        expr: |
          sum(node_filesystem_size_bytes{fstype!~"tmpfs|fuse.*"}) 
          / 1024 / 1024 / 1024 / 1024

      # Bandwidth total receive (Mbps)
      - record: swarm:cluster:network_receive_mbps_total
        expr: sum(swarm:node:network_receive_mbps)

      # Bandwidth total transmit (Mbps)
      - record: swarm:cluster:network_transmit_mbps_total
        expr: sum(swarm:node:network_transmit_mbps)

  # ---------------------------------------------------------------------------
  # Service-level aggregations
  # ---------------------------------------------------------------------------
  - name: service_aggregations
    interval: 30s
    rules:
      # Nombre de réplicas running par service
      - record: swarm:service:replicas_running
        expr: |
          count by (service) (
            up{scrape_type="swarm-task", desired_state="running"} == 1
          )

      # Nombre total de services
      - record: swarm:cluster:services_total
        expr: count(swarm:service:replicas_running)

      # Health ratio par service (0-1)
      - record: swarm:service:health_ratio
        expr: |
          (
            count by (service) (up{scrape_type="swarm-task"} == 1)
            /
            count by (service) (up{scrape_type="swarm-task"})
          )

  # ---------------------------------------------------------------------------
  # Container-level aggregations (cAdvisor)
  # ---------------------------------------------------------------------------
  - name: container_aggregations
    interval: 30s
    rules:
      # CPU usage par container (%)
      - record: swarm:container:cpu_usage_percent
        expr: |
          sum by (name, node) (
            irate(container_cpu_usage_seconds_total{name!~".*POD.*"}[5m])
          ) * 100

      # Memory usage par container (Mo)
      - record: swarm:container:memory_usage_mb
        expr: |
          sum by (name, node) (
            container_memory_usage_bytes{name!~".*POD.*"}
          ) / 1024 / 1024

      # Network receive par container (KB/s)
      - record: swarm:container:network_receive_kb_per_sec
        expr: |
          sum by (name, node) (
            irate(container_network_receive_bytes_total{name!~".*POD.*"}[5m])
          ) / 1024

      # Network transmit par container (KB/s)
      - record: swarm:container:network_transmit_kb_per_sec
        expr: |
          sum by (name, node) (
            irate(container_network_transmit_bytes_total{name!~".*POD.*"}[5m])
          ) / 1024

  # ---------------------------------------------------------------------------
  # Traefik aggregations
  # ---------------------------------------------------------------------------
  - name: traefik_aggregations
    interval: 30s
    rules:
      # Request rate par service
      - record: traefik:service:request_rate
        expr: |
          sum by (service) (
            irate(traefik_service_requests_total[5m])
          )

      # Request duration p95 par service
      - record: traefik:service:request_duration_p95
        expr: |
          histogram_quantile(0.95,
            sum by (service, le) (
              irate(traefik_service_request_duration_seconds_bucket[5m])
            )
          )

      # Request duration p99 par service
      - record: traefik:service:request_duration_p99
        expr: |
          histogram_quantile(0.99,
            sum by (service, le) (
              irate(traefik_service_request_duration_seconds_bucket[5m])
            )
          )

      # Error rate par service (%)
      - record: traefik:service:error_rate_percent
        expr: |
          (
            sum by (service) (
              irate(traefik_service_requests_total{code=~"5.."}[5m])
            )
            /
            sum by (service) (
              irate(traefik_service_requests_total[5m])
            )
          ) * 100

      # Total requests per second
      - record: traefik:cluster:requests_per_sec
        expr: sum(traefik:service:request_rate)

  # ---------------------------------------------------------------------------
  # Security stack aggregations
  # ---------------------------------------------------------------------------
  - name: security_aggregations
    interval: 60s
    rules:
      # Nombre d'outils security up
      - record: security:tools:up_count
        expr: count(up{component="security"} == 1)

      # Health global de la stack security
      - record: security:stack:health_ratio
        expr: |
          count(up{component="security"} == 1)
          /
          count(up{component="security"})

# =============================================================================
# NOTES
# =============================================================================
# 
# Ces recording rules pré-calculent des métriques fréquemment utilisées
# pour améliorer les performances des dashboards Grafana.
# 
# Avantages:
# - Requêtes Grafana plus rapides
# - Moins de charge sur Prometheus lors du rendering
# - Métriques cohérentes à travers tous les dashboards
# 
# Pour vérifier les recording rules:
# promtool check rules recording_rules.yml
# 
# =============================================================================
