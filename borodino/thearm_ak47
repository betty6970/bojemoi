#!/bin/ash

# Variables
set HOME="/opt/bojemoi"
export POSTGRESQL
user="postgres"            # Nom d'utilisateur PostgreSQL
password="bojemoi"             # Mot de passe PostgreSQL
dbname="msf"               # Base de données par défaut


# Attendre que PostgreSQL soit prêt (retry indéfini)
echo "[ATTENTE] Résolution DNS postgres..."
while true; do
    ip=$(ping -c 1 -W 1 "postgres" 2>/dev/null | head -n 1 | awk '{print $3}')
    sql_ip="${ip:1:-2}"
    if [ -n "$sql_ip" ] && ping -c 1 -W 1 "postgres" &>/dev/null; then
        if pg_isready -h "$sql_ip" -U "$user" -d "$dbname" > /dev/null 2>&1; then
            echo "[INFO] PostgreSQL détecté à $sql_ip"
            break
        else
            echo "[ATTENTE] PostgreSQL pas prêt à $sql_ip... retry dans 10s"
        fi
    else
        echo "[ATTENTE] Résolution DNS postgres... retry dans 10s"
    fi
    sleep 10
done

while true; do
ip=$(echo " select cidr_z from ip2location_db1 TABLESAMPLE SYSTEM(1) where country_code = 'RU' and nmap = '0' limit 1;" |PGPASSWORD=bojemoi psql -h $sql_ip -U postgres -d ip2location -t )
output="${ip#?}"
echo "current cidr :$output on going"
tz=$(echo " update ip2location_db1 set nmap = '1', date_nmap = (SELECT CURRENT_TIMESTAMP) where cidr_z  >>= '$output' ;")
echo $tz |PGPASSWORD=bojemoi psql -h $sql_ip -U postgres -d ip2location 

msfconsole -q -x "db_connect postgres:bojemoi@$sql_ip/$dbname;db_nmap -sS -A -O --reason --traceroute --spoof-mac 0 -f  --mtu 16  --data-length 64 --randomize-hosts -PA -PM -Pn   $output; quit"

echo "cidr :$output done"
tz=$(echo " update ip2location_db1 set nmap = '2', date_nmap = (SELECT CURRENT_TIMESTAMP) where cidr_z  >>= '$output' ;")
echo $tz |PGPASSWORD=bojemoi psql -h $sql_ip -U postgres -d ip2location 

done

