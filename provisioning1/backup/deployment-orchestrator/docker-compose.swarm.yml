version: '3.8'

services:
  orchestrator:
    image: registry.bojemoi.lab/deployment-orchestrator:latest
    hostname: orchestrator
    networks:
      - bojemoi_network
    ports:
      - target: 8080
        published: 8080
        protocol: tcp
        mode: host
      - target: 9090
        published: 9090
        protocol: tcp
        mode: host
    volumes:
      # Socket Docker pour piloter les containers
      - /var/run/docker.sock:/var/run/docker.sock
      # Logs persistants
      - orchestrator_logs:/app/logs
      # Cache
      - orchestrator_cache:/app/cache
    environment:
      - WEBHOOK_PORT=8080
      - LOG_LEVEL=INFO
      - GITEA_URL=${GITEA_URL}
      - GITEA_TOKEN=${GITEA_TOKEN}
      - GITEA_WEBHOOK_SECRET=${GITEA_WEBHOOK_SECRET}
      - POSTGRES_HOST=${POSTGRES_HOST}
      - POSTGRES_PORT=${POSTGRES_PORT}
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - XENSERVER_URL=${XENSERVER_URL}
      - XENSERVER_USER=${XENSERVER_USER}
      - XENSERVER_PASSWORD=${XENSERVER_PASSWORD}
      - DOCKER_SWARM_ENABLED=true
      - CLOUD_INIT_DATASOURCE_URL=${CLOUD_INIT_DATASOURCE_URL}
      - PROMETHEUS_ENABLED=true
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          # Déployer sur un manager node pour accès au socket Docker
          - node.role == manager
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        monitor: 60s
      labels:
        # Labels Bojemoi
        - "bojemoi.service=orchestrator"
        - "bojemoi.environment=production"
        
        # Labels Prometheus
        - "prometheus.scrape=true"
        - "prometheus.port=9090"
        
        # Traefik - Configuration générale
        - "traefik.enable=true"
        - "traefik.docker.network=bojemoi_network"
        
        # Traefik - API HTTP (port 8080)
        - "traefik.http.routers.orchestrator-api.rule=Host(`orchestrator.bojemoi.lab`)"
        - "traefik.http.routers.orchestrator-api.entrypoints=websecure"
        - "traefik.http.routers.orchestrator-api.tls=true"
        - "traefik.http.routers.orchestrator-api.tls.certresolver=letsencrypt"
        - "traefik.http.routers.orchestrator-api.service=orchestrator-api"
        - "traefik.http.services.orchestrator-api.loadbalancer.server.port=8080"
        
        # Traefik - Webhook endpoint avec rate limiting
        - "traefik.http.routers.orchestrator-webhook.rule=Host(`orchestrator.bojemoi.lab`) && PathPrefix(`/webhook`)"
        - "traefik.http.routers.orchestrator-webhook.entrypoints=websecure"
        - "traefik.http.routers.orchestrator-webhook.tls=true"
        - "traefik.http.routers.orchestrator-webhook.middlewares=orchestrator-ratelimit"
        - "traefik.http.middlewares.orchestrator-ratelimit.ratelimit.average=10"
        - "traefik.http.middlewares.orchestrator-ratelimit.ratelimit.burst=20"
        
        # Traefik - Metrics Prometheus (port 9090)
        - "traefik.http.routers.orchestrator-metrics.rule=Host(`orchestrator.bojemoi.lab`) && PathPrefix(`/metrics`)"
        - "traefik.http.routers.orchestrator-metrics.entrypoints=websecure"
        - "traefik.http.routers.orchestrator-metrics.tls=true"
        - "traefik.http.routers.orchestrator-metrics.service=orchestrator-metrics"
        - "traefik.http.services.orchestrator-metrics.loadbalancer.server.port=9090"
        
        # Traefik - Health check
        - "traefik.http.routers.orchestrator-health.rule=Host(`orchestrator.bojemoi.lab`) && PathPrefix(`/health`)"
        - "traefik.http.routers.orchestrator-health.entrypoints=websecure"
        - "traefik.http.routers.orchestrator-health.tls=true
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  postgres:
    image: postgres:15-alpine
    hostname: postgres.bojemoi.lab
    networks:
      - bojemoi_network
    environment:
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - PGDATA=/var/lib/postgresql/data/pgdata
    volumes:
      - postgres_data:/var/lib/postgresql/data
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          # Toujours sur le même node pour la persistance
          - node.labels.postgres == true
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      labels:
        - "bojemoi.service=postgres"
        - "bojemoi.environment=production"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5

networks:
  bojemoi_network:
    external: true

volumes:
  postgres_data:
    driver: local
  orchestrator_logs:
    driver: local
  orchestrator_cache:
    driver: local
