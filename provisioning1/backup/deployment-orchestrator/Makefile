.PHONY: help build up down restart logs shell db-shell test clean

help: ## Affiche cette aide
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

build: ## Build l'image Docker
	docker-compose build

up: ## D√©marre les services
	docker-compose up -d
	@echo "‚úÖ Services d√©marr√©s"
	@echo "üìç API: http://localhost:8080"
	@echo "üìä Metrics: http://localhost:9090/metrics"
	@echo "üíö Health: http://localhost:8080/health"

down: ## Arr√™te les services
	docker-compose down

restart: down up ## Red√©marre les services

logs: ## Affiche les logs
	docker-compose logs -f orchestrator

shell: ## Ouvre un shell dans le container
	docker-compose exec orchestrator bash

db-shell: ## Ouvre un shell PostgreSQL
	docker-compose exec postgres psql -U deployment_user -d deployments

test-webhook: ## Teste le webhook (n√©cessite jq)
	@curl -X POST http://localhost:8080/webhook/gitea \
		-H "Content-Type: application/json" \
		-d '{"ref":"refs/heads/main","repository":{"name":"test-repo","owner":{"username":"betty"}},"commits":[{"id":"abc123","message":"test"}]}'

health: ## V√©rifie le health check
	@curl -s http://localhost:8080/health | jq

deployments: ## Liste les d√©ploiements r√©cents
	@curl -s http://localhost:8080/deployments | jq

metrics: ## Affiche les m√©triques
	@curl -s http://localhost:9090/metrics

clean: ## Nettoie les volumes et containers
	docker-compose down -v
	rm -rf logs/* cache/*

init-db: ## Initialise la base de donn√©es
	docker-compose exec postgres psql -U deployment_user -d deployments -c "\dt"

backup-db: ## Backup de la base de donn√©es
	docker-compose exec postgres pg_dump -U deployment_user deployments > backup_$(shell date +%Y%m%d_%H%M%S).sql

status: ## Affiche le statut des services
	@docker-compose ps

dev: ## Mode d√©veloppement avec rechargement automatique
	docker-compose -f docker-compose.yml -f docker-compose.dev.yml up
