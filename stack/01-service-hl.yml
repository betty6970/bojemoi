# servic high-level
#--------------------------------------------------------------------------------
# for base  images
# -------------------------------------------------------------------------------
networks:
  monitoring:
    name: monitoring
    driver: overlay
    attachable: true
  backend:
    name: backend
    driver: overlay
    attachable: true
  rsync_network:
    name: rsync_network
    driver: overlay
    attachable: true
  proxy:
    name: proxy
    driver: overlay
    attachable: true
  mail:
    name: mail
    driver: overlay
    attachable: true

volumes:
  postgres_data:
    external: true
    name: bojemoi
  registry_data:
    external: true
    name: registry
  grafana_data:
    driver: local
  prometheus_data:
    name: prometheus_data
    external: true
  loki_data:
    driver: local
  alertmanager_data: 
  ssh_keys:
    driver: local  
  shared_logs:
    external: true
  postfix_data:
    driver: local
  postfix_mail:
    driver: local
  postfix_log:
    driver: local
  suricata_logs:
    driver: local
  pgadmin-data:
    driver: local
  traefik-certificates:
    driver: local
  traefik-logs:
    driver: local
  tempo-data:
    driver: local
  crowdsec_data:
    driver: local

  traefik-certs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/bojemoi/volumes/traefik/certs  # Adjust path to your certs directory
  protonmail_data:
    driver: local
  # Provisioning orchestrator volumes
  provisioning_logs:
    driver: local
  provisioning_cache:
    driver: local

secrets:
   rsync_config:
     file: /opt/bojemoi/volumes/rsync/configs/rsyncd.conf
   ssh_private_key:
     file: /opt/bojemoi/volumes/rsync/ssh-keys/id_rsa
   proton_username:
     external: true
   proton_password:
     external: true
configs:
   traefik_tls_config:
     file: /opt/bojemoi/volumes/traefik/traefik-tls.yml
   alertmanager_config:
     file: /opt/bojemoi/volumes/alertmanager/alertmanager.yml
   tls_alertmanager_config:
     file: /opt/bojemoi/volumes/alertmanager/certs/protonmail-bridge.crt
   alloy_config:
     file: /opt/bojemoi/volumes/alloy/config/config.alloy
   dnsmask_config:
     file: /opt/bojemoi/volumes/dnsmask/dnsmask.conf
   grafana-ini_config:
     file: /opt/bojemoi/volumes/grafana/grafana.ini
   grafana-provisioning_config:
     file: /opt/bojemoi/volumes/grafana/provisioning/dashboards/dashboards.yml 
   grafana-dashboard_config: 
     file: /opt/bojemoi/volumes/grafana/provisioning/datasources/datasources.yml 
   loki_config:
     file: /opt/bojemoi/volumes/loki/loki-config.yml
   postfix_config:
     file: /opt/bojemoi/volumes/postfix/main.cf
   prometheus_config:
     file: /opt/bojemoi/volumes/prometheus/prometheus.yml
   rsync_config:
     file: /opt/bojemoi/volumes/rsync/configs/rsyncd.conf
   suricata_config:
     file: /opt/bojemoi/volumes/suricata/suricata.yaml
   suricata_rules_config:
     file:  /opt/bojemoi/volumes/suricata/rules/emerging-threats.rules
   suricata_rules1_config:
     file:  /opt/bojemoi/volumes/suricata/rules/suricata.rules
   tempo_config:
     file: /opt/bojemoi/volumes/tempo/config/tempo.yaml
   traefik_config:
     file: /opt/bojemoi/volumes/traefik/dynamic-config.yml
   crowdsec_config:
     file: /opt/bojemoi/volumes/crowdsec/config/acquis.yaml
   registry_config:
     file: /opt/bojemoi/volumes/registry/config.yml
   provisioning_env:
     file: /opt/bojemoi/volumes/provisioning/.env

# Template de base avec anchor                                                   
x-mode-template: &mode-template                                             
  image: localhost:5000/koursk:latest
  networks:                          
    -  backend                       

# Template de d..ploiement s..par..
x-deploy-template: &deploy-template
    labels:
       - prometheus.enable=true
       - prometheus.port=8080
       - prometheus.path=/metrics
       - prometheus.label.team=security
       - prometheus.label.component=pentest-orchestrator
       - prometheus.label.stack=armement
       - prometheus.label.tool=armement
    placement:                     
      max_replicas_per_node: 1     
    restart_policy:                
      condition: on-failure   
      delay: 5s               
      max_attempts: 3         
    update_config:                                   
      parallelism: 1                                 
      delay: 10s                                     
#      failure_action: rollback                       
    resources:                                       
      limits:                                        
        cpus: '0.1'                                     
        memory: 512M                                    
      reservations:                                     
        cpus: '0.1'                                     
        memory: 100M                                    

services:
  #======================================================================
  # SERVICE: Docker Socket Proxy (sécurité - proxy filtrant pour l'API Docker)
  #======================================================================
  docker-socket-proxy:
    image: tecnativa/docker-socket-proxy:0.2.0
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 64M
      labels:
        - prometheus.enable=false
        - prometheus.label.team=infrastructure
        - prometheus.label.component=docker-proxy
        - prometheus.label.stack=base
        - prometheus.label.tier=security
    environment:
      # Lecture seule - pas de POST/DELETE
      - POST=0
      - DELETE=0
      # API endpoints autorisés (lecture)
      - CONTAINERS=1
      - SERVICES=1
      - TASKS=1
      - NETWORKS=1
      - NODES=1
      - IMAGES=1
      - VOLUMES=1
      - INFO=1
      - SWARM=1
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - backend                                                                   
  # =========================================================================
  # SERVICE:  registry 
  # ========================================================================
  registry:
    image: registry:2
    ports:
      - 5000:5000
    configs:
      - source: registry_config
        target: /etc/docker/registry/config.yml
    volumes:
      - registry_data:/var/lib/registry
    networks:
      - monitoring
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
      labels:
        - prometheus.enable=false
        - prometheus.port=5000
        - prometheus.path=/metrics
        - prometheus.label.team=infrastructure
        - prometheus.label.component=docker-registry
        - prometheus.label.stack=base
        - prometheus.label.tier=data

  # =========================================================================
  # SERVICE:  dns
  # =========================================================================
  dnsmask:
     image: localhost:5000/dnsmasq:latest
     volumes:
         - /opt/bojemoi/volumes/dnsmask/dnsmask.conf:/etc/dnsmasq.conf
         - /opt/bojemoi/volumes/dnsmask/dnsmask.d:/etc/dnsmasq.d
     networks:
         - monitoring
         - proxy
     ports:
         - 8080:8080
         - 53:53/udp
         - 53:53/tcp
     deploy:
        replicas: 1
        placement:
          constraints:
            - node.role == manager
        labels:
            - com.docker.stack.image=jpillora/dnsmasq
            - com.docker.stack.namespace=base
            - traefik.enable=true
  # Router HTTP
            - traefik.http.routers.dnsmasq.rule=Host(`dnsmasq.bojemoi.lab`)
            - traefik.http.routers.dnsmasq.entrypoints=web
            - traefik.http.routers.dnsmasq.middlewares=redirect-to-https
  
  # Router HTTPS
            - traefik.http.routers.dnsmasq-secure.rule=Host(`dnsmasq.bojemoi.lab`)
            - traefik.http.routers.dnsmasq-secure.entrypoints=websecure
            - traefik.http.routers.dnsmasq-secure.tls=true
  
  # Service
            - traefik.http.services.dnsmasq.loadbalancer.server.port=8080
  
  # Important: définir le réseau Docker sur lequel Traefik doit router
            - traefik.swarm.network=proxy
  
  # Middleware HTTPS redirect (si pas déjà global)
            - traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https
            - traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true

            - prometheus.enable=false
            - prometheus.port=9153
            - prometheus.path=/metrics
            - prometheus.label.team=infrastructure
            - prometheus.label.component=dns
            - prometheus.label.stack=base
            - prometheus.label.tier=network
        update_config:
          parallelism: 1
          delay: 10s
          order: stop-first  # Important pour DNS
#          failure_action: rollback
        restart_policy:
          condition: on-failure
          delay: 5s
          max_attempts: 3

  # =========================================================================
  # SERVICE:  reverse proxy
  # =========================================================================
  traefik:
    image: localhost:5000/traefik:latest
    command:
      # API et Dashboard
      - --api.dashboard=true
      - --api.insecure=true
      
      # Logs
#      - --log.level=INFO
      - --accesslog=true

      - --providers.file.directory=/etc/traefik/dynamic
 
      # Docker Swarm
      - --providers.swarm.network=proxy
      - --providers.swarm=true
      - --providers.swarm.endpoint=tcp://docker-socket-proxy:2375
      - --providers.swarm.exposedbydefault=false
   
      # Points d'entrée
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      - --entrypoints.web.http.redirections.entrypoint.to=websecure
      - --entrypoints.web.http.redirections.entrypoint.scheme=https
      
      
      # Métriques Prometheus (optionnel)
      - --metrics.prometheus=true
      - --metrics.prometheus.addEntryPointsLabels=true
      - --metrics.prometheus.addServicesLabels=true
#    command:
      # Ajoutez ces lignes pour les métriques
      - --metrics.prometheus=true
      - --entryPoints.metrics.address=:8085
      - --metrics.prometheus.entryPoint=metrics
      # Optionnel : ajouter des buckets personnalisés
      - --metrics.prometheus.buckets=0.1,0.3,1.0,2.5,5.0


    ports:
      - target: 80
        published: 80
        mode: host
      - target: 443
        published: 443
        mode: host
      
    volumes:
      - /opt/bojemoi/volumes/traefik/var/log/traefik:/var/log/traefik
      - traefik-certificates:/letsencrypt
      - /opt/bojemoi/volumes/traefik/certs:/etc/traefik/certs:ro
      - /opt/bojemoi/volumes/traefik/dynamic-config.yml:/etc/traefik/dynamic/dynamic.yml:ro
    networks:
      - proxy
      - backend
      - monitoring
    deploy:
      mode: global
      placement:
        constraints:
          - node.role == manager

      labels:
        - prometheus.enable=true
        - prometheus.port=8082
        - prometheus.path=/metrics
        - prometheus.label.team=infrastructure
        - prometheus.label.component=reverse-proxy
        - prometheus.label.stack=base
        - prometheus.label.tier=network
# Dashboard Traefik
        - traefik.enable=true
        - traefik.swarm.network=proxy      
        - traefik.http.routers.traefik-dashboard.rule=Host(`traefik.bojemoi.lab`)
        - traefik.http.routers.traefik-dashboard.entrypoints=websecure
        - traefik.http.routers.traefik-dashboard.tls=true
        - traefik.http.routers.traefik-dashboard.service=api@internal
  
    # Authentification basique pour le dashboard - NOM COHÉRENT
        - traefik.http.routers.traefik-dashboard.middlewares=traefik-auth,security-headers
        - traefik.http.middlewares.traefik-auth.basicauth.users=admin:$$apr1$$cwwK8JxY$$FjlrCx7PCP6V1kJa66X/E1
  
    # Middleware pour les headers de sécurité
        - traefik.http.middlewares.security-headers.headers.stsSeconds=31536000
        - traefik.http.middlewares.security-headers.headers.stsIncludeSubdomains=true
        - traefik.http.middlewares.security-headers.headers.stsPreload=true
        - traefik.http.middlewares.security-headers.headers.forceSTSHeader=true
        - traefik.http.middlewares.security-headers.headers.customResponseHeaders.X-Robots-Tag=noindex,nofollow,nosnippet,noarchive
        - traefik.http.middlewares.security-headers.headers.customResponseHeaders.X-Frame-Options=SAMEORIGIN
        - traefik.http.middlewares.security-headers.headers.customResponseHeaders.X-Content-Type-Options=nosniff
        - traefik.http.middlewares.security-headers.headers.customResponseHeaders.Referrer-Policy=strict-origin-when-cross-origin
        # Service
        - traefik.http.services.traefik.loadbalancer.server.port=8080
  # =========================================================================
  #
  # =========================================================================
  crowdsec:
    image: crowdsecurity/crowdsec:latest
    environment:
      # Collections à installer
      COLLECTIONS: "crowdsecurity/traefik crowdsecurity/http-cve"
      GID: "1000"
    configs:
      -  source:  crowdsec_config
         target: /etc/crowdsec/acquis.yaml
    volumes:
      # Logs à analyser
      - /opt/bojemoi/volumes/traefik/var/log/traefik:/var/log/traefik:ro
      # Config et data
      - crowdsec_data:/var/lib/crowdsec/data
    dns_search:
      - bojemoi.lab
    networks:
      - proxy 
      - backend
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      labels:
        - traefik.enable=false
        - "prometheus.enable=true"
        - "prometheus.port=6060"
        - "prometheus.path=/metrics"
      restart_policy:
          condition: on-failure
          delay: 5s
          max_attempts: 3
  # =========================================================================
  #
  # =========================================================================

  traefik-bouncer:
    image: fbonalair/traefik-crowdsec-bouncer:latest
    environment:
      CROWDSEC_BOUNCER_API_KEY: '4vpAP15xu7FzVeME/J5nHB5jn/2mjZTPoj96mI2GP+8'
#API key for 'traefik-bouncer':
#   4vpAP15xu7FzVeME/J5nHB5jn/2mjZTPoj96mI2GP+8
#Please keep this key since you will not be able to retrieve it!
# 
# # Or for iptables bouncer:
# cscli bouncers add iptables-bouncer
#API key for 'iptables-bouncer':
#   +Snnd7UwspbeBLwDtOzyNuOKWoIcCq4iMuKj2HPdJnc

 
      CROWDSEC_AGENT_HOST: crowdsec:8080
      GIN_MODE: release
    networks:
      - proxy
    deploy:
      mode: replicated
      replicas: 1
      labels:
        # Middleware Traefik pour vérifier les IPs
        - "traefik.enable=false"
        - "traefik.http.middlewares.crowdsec.forwardauth.address=http://traefik-bouncer:8080/api/v1/forwardAuth"
        - "traefik.http.middlewares.crowdsec.forwardauth.trustForwardHeader=true"


  # =========================================================================
  # SERVICE:  postgres
  # =========================================================================

  postgres:
    image: localhost:5000/postgres:latest 
    environment:
      POSTGRES_PASSWORD: bojemoi 
      POSTGRES_USER: postgres 
      POSTGRES_DB: msf 
    volumes:
      - postgres_data:/var/lib/postgresql/
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      placement:
        constraints:
          - node.role == manager
      labels:
        - prometheus.enable=false  # Pas de metrics directes
        - prometheus.label.team=infrastructure
        - prometheus.label.component=database
        - prometheus.label.stack=base
        - prometheus.label.tier=data
    ports:
      - 5432:5432
    networks:
      -  backend
    stop_grace_period: 30s
  # =========================================================================
  # =========================================================================

  pgadmin:
    image: localhost:5000/pgadmin4
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@admin.com
      PGADMIN_DEFAULT_PASSWORD: root
    volumes:
      - pgadmin-data:/var/lib/pgadmin
    networks:
      - backend
      - proxy
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      placement:
        constraints:
           - node.role == manager
      labels:
        - prometheus.enable=false  # Pas de metrics Prometheus
        - prometheus.label.team=infrastructure
        - prometheus.label.component=database-admin
        - prometheus.label.stack=base
        - prometheus.label.tier=data
        - traefik.enable=true
        - traefik.swarm.network=proxy
        # Router HTTP
        - traefik.http.routers.pgadmin.rule=Host(`pgadmin.bojemoi.lab`)
        - traefik.http.routers.pgadmin.entrypoints=web
        - traefik.http.routers.pgadmin.middlewares=redirect-to-https
        # Router HTTPS
        - traefik.http.routers.pgadmin-secure.rule=Host(`pgadmin.bojemoi.lab`)
        - traefik.http.routers.pgadmin-secure.entrypoints=websecure
        - traefik.http.routers.pgadmin-secure.tls=true
#        - traefik.http.routers.pgadmin-secure.tls.certresolver=letsencrypt
        # Service
        - traefik.http.services.pgadmin.loadbalancer.server.port=80


  # =========================================================================
  # SERVICE: suricata 
  # =========================================================================
  suricata:
    image: localhost:5000/suricata:latest 
    hostname: "suricata{{.Node.Hostname}}"
    networks:
      - monitoring
    cap_add:
      - NET_ADMIN
      - SYS_NICE
      - NET_RAW
    environment:
      - SURICATA_OPTIONS=-i eth0 --set stream.reassembly.depth=0 --set detect.profile=low
#    configs:
#      - source: suricata_config
#        target: /etc/suricata/suricata.yaml
#      - source: suricata_rules_config
#        target: /etc/suricata/rules/suricata.rules
#      - source: suricata_rules1_config
#        target: /etc/suricata/rules/emerging-threats.rules
#    command: 
#       - "-c suricata.yaml"
#       - "--unix-socket=/var/run/suricata/suricata-command.socket"
#       - "-i eth0"

    volumes:
      - /opt/bojemoi/volumes/suricata/logs:/var/log/suricata
      - /opt/bojemoi/volumes/suricata:/etc/suricata
    deploy:
      mode: global  # Clé importante : déploie une instance sur chaque node
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      labels:
        - prometheus.enable=false  # Utilise l'exporter dédié
        - prometheus.label.team=security
        - prometheus.label.component=ids-ips
        - prometheus.label.stack=base
        - prometheus.label.tier=security
  #===============================
  #
  #===============================
  # Suricata Exporter pour les métriques Prometheus
  suricata-exporter:
    image: localhost:5000/suricata_exporter
    volumes:
      - /opt/bojemoi/volumes/suricata/logs:/var/log/suricata
    networks:
      - monitoring
      - backend
    ports:
      - 9917:9917
    command: 
      - '--suricata.socket-path=/var/run/suricata/suricata-command.socket'
    deploy:
      mode: global  # Clé importante : déploie une instance sur chaque node
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      labels:
        - prometheus.enable=true
        - prometheus.port=9917
        - prometheus.path=/metrics
        - prometheus.label.team=security
        - prometheus.label.component=ids-exporter
        - prometheus.label.stack=base
        - prometheus.label.tier=security

  # =========================================================================
  # SERVICE: Grafana (Serveur principal de visualisation)
  # =========================================================================
  grafana:
    image: localhost:5000/grafana:latest
    networks:
      - proxy
      - backend
      - monitoring
    dns_search:
      - bojemoi.lab
    ports:
      -  3000:3000
    environment:
      GF_SERVER_ROOT_URL: http://localhost:3000
      GF_SECURITY_ADMIN_PASSWORD: admin_password
      GF_USERS_ALLOW_SIGN_UP: "false"
      GF_DATABASE_TYPE: postgres
      GF_DATABASE_HOST: postgres:5432
      GF_DATABASE_NAME: grafana
      GF_DATABASE_USER: postgres
      GF_DATABASE_PASSWORD: bojemoi 
      GF_DATABASE_SSL_MODE: disable
    configs:
      - source: grafana-ini_config
        target: /etc/grafana/grafana.ini
      - source: grafana-provisioning_config
        target: /etc/grafana/provisioning/datasources/datasources.yml 
      - source: grafana-dashboard_config
        target: /etc/grafana//provisioning/dashboards/dashboards.yml 
 
    volumes:
      # Données persistantes (DB, plugins, sessions)
      - grafana_data:/var/lib/grafana
      

    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      labels:
        - prometheus.enable=true
        - prometheus.port="3000"
        - prometheus.path=/metrics
        - prometheus.label.team=infrastructure
        - prometheus.label.component=visualization
        - prometheus.label.stack=base
        - prometheus.label.tier=monitoring
        - traefik.enable=true
        - traefik.swarm.network=proxy       
      # Définir le router HTTP (avec redirection HTTPS)
        - traefik.http.routers.grafana.rule=Host(`grafana.bojemoi.lab`)
        - traefik.http.routers.grafana.entrypoints=web
        - traefik.http.routers.grafana.middlewares=redirect-to-https
  
      # Définir le router HTTPS
        - traefik.http.routers.grafana-secure.rule=Host(`grafana.bojemoi.lab`)
        - traefik.http.routers.grafana-secure.entrypoints=websecure
        - traefik.http.routers.grafana-secure.tls=true
  
  # Définir le service et le port
        - traefik.http.services.grafana.loadbalancer.server.port=3000
  
  # Middleware de redirection HTTPS (si pas déjà défini globalement)
        - traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https
        - traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true  

  #================================================
  #
  #================================================

  tempo:
    image: grafana/tempo:latest

    command: ["-config.file=/etc/tempo/tempo.yaml"]
    volumes:
      - /opt/bojemoi/volumes/tempo/config/tempo.yaml:/etc/tempo/tempo.yaml:ro
      - tempo-data:/var/tempo
    ports:
      - "3200:3200"   # Tempo API
      - "4317:4317"   # OTLP gRPC (← C'est ce port dans ton erreur!)
      - "4318:4318"   # OTLP HTTP
      - "9411:9411"   # Zipkin
    networks:
      - proxy 
      - monitoring
      - backend
    dns_search:
      - bojemoi.lab
    deploy:
      labels:
        # Prometheus scraping
        - prometheus.enable=true
        - prometheus.port=3200
        - prometheus.path=/metrics
        - prometheus.job=tempo
        - prometheus.label.team=infrastructure
        - prometheus.label.component=tracing
        - prometheus.label.stack=base
        - prometheus.label.tier=monitoring
        # Traefik - UI Web
        - traefik.enable=true
        - traefik.http.routers.tempo.rule=Host(`tempo.bojemoi.lab`)
        - traefik.http.routers.tempo.entrypoints=websecure
        - traefik.http.routers.tempo.tls=true
        - traefik.http.services.tempo.loadbalancer.server.port=3200
        
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M






  # =========================================================================
  # SERVICE: Prometheus (Collecte et stockage de métriques)
  # =========================================================================
  prometheus:
    user: "65534:1003" 
    image: localhost:5000/prometheus:latest
  
  
    dns_search:
      - bojemoi.lab
    networks:
      - monitoring
      - rsync_network
      - proxy
    ports:
      - 9090:9090
    command:
      - --log.level=debug
      - --config.file=/etc/prometheus/prometheus.yml
      - --storage.tsdb.path=/prometheus
      - '--storage.tsdb.retention.time=15d'    # 30 jours pour l'analyse
      - '--storage.tsdb.retention.size=10GB'   # Limite de sécurité
      - '--storage.tsdb.wal-compression'       # Compression du WAL
      - --web.console.libraries=/usr/share/prometheus/console_libraries
      - --web.console.templates=/usr/share/prometheus/consoles
      - --web.enable-lifecycle
      - --web.enable-remote-write-receiver
    configs:
      - source: prometheus_config
        target: /etc/prometheus/prometheus.yml
    volumes:
      - prometheus_data:/prometheus
    # Note: Socket Docker retiré - utilise docker-socket-proxy via prometheus.yml si nécessaire
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      placement:
        constraints:
          - node.role == manager
      labels:
          - prometheus.enable=true
          - prometheus.port=9090
          - prometheus.path=/metrics
          - prometheus.label.team=infrastructure
          - prometheus.label.component=metrics-storage
          - prometheus.label.stack=base
          - prometheus.label.tier=monitoring
          - com.docker.stack.image=prom/prometheus:latest
          - com.docker.stack.namespace=base
          - traefik.enable=true
          - traefik.swarm.network=proxy       
  # Router Prometheus
          - traefik.http.routers.prometheus.rule=Host(`prometheus.bojemoi.lab`)
          - traefik.http.routers.prometheus.entrypoints=websecure
          - traefik.http.routers.prometheus.tls=true
          - traefik.http.routers.prometheus.middlewares=prometheus-auth
  # Service
          - traefik.http.services.prometheus.loadbalancer.server.port=9090
  # Authentification - HASH COMPLET !
          - traefik.http.middlewares.prometheus-auth.basicauth.users=admin:$$apr1$$rH8L9x2v$$pQzKvM3F8xY2nW5tR7sD91


  # =========================================================================
  # SERVICE: Loki (Agrégation et stockage de logs)
  # =========================================================================
  loki:
    image: localhost:5000/loki:latest
    networks:
      - monitoring
      - backend
    dns_search:
      - bojemoi.lab
    ports:
      - 3100:3100
    command:
      -  -config.file=/etc/loki/local-config.yml
      -  -config.expand-env=true 
      -  -log.level=debug
    configs:
      - source: loki_config
        target: /etc/loki/local-config.yml
    volumes:
      - loki_data:/loki
    deploy:
      mode: replicated
      replicas: 1  
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      labels:
        - prometheus.enable=true
        - prometheus.port=3100
        - prometheus.path=/metrics
        - prometheus.label.team=infrastructure
        - prometheus.label.component=log-aggregation
        - prometheus.label.stack=base
        - prometheus.label.tier=monitoring
  # =========================================================================
  # =========================================================================
  alloy:
    image: localhost:5000/alloy:latest
    ports:
      - 12345:12345
    configs:
      - source: alloy_config
        target: /etc/alloy/config.alloy
    environment:
      - DOCKER_HOST=tcp://docker-socket-proxy:2375
    volumes:
      - shared_logs:/rsync/logs
    command:
      - run
      - /etc/alloy/config.alloy
      - --server.http.listen-addr=0.0.0.0:12345
      - --storage.path=/var/lib/alloy/data
    networks:
      - monitoring
      - backend
    dns_search:
      - bojemoi.lab
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      labels:
        - prometheus.enable=false
        - prometheus.port=12345
        - prometheus.path=/metrics
        - prometheus.label.team=infrastructure
        - prometheus.label.component=telemetry-collector
        - prometheus.label.stack=base
        - prometheus.label.tier=monitoring
##############
  # =========================================================================
  # =========================================================================
  alertmanager:
    image: localhost:5000/alertmanager:latest
    ports:
      - 9093:9093
    configs:
      - source: tls_alertmanager_config
        target: /etc/alertmanager/certs/protonmail-bridge.crt
    volumes:
#      - /opt/bojemoi/volumes/alertmanager/templates/default.tmpl:/etc/alertmanager/templates/default.tmpl:ro
      - /opt/bojemoi/volumes/alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
      - alertmanager_data:/alertmanager
    command:
      - '--config.file=/etc/alertmanager/alertmanager.yml'
      - '--storage.path=/alertmanager'
      - '--web.external-url=http://alertmanager.bojemoi.lab:9093/'
      - '--log.level=debug'
    networks:
      - monitoring
      - proxy
      - mail
    dns_search:
      - bojemoi.lab
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      placement:
        constraints:
          - node.role == manager
      labels:
        - prometheus.enable=true
        - prometheus.port=9093
        - prometheus.path=/metrics
        - prometheus.label.team=infrastructure
        - prometheus.label.component=alerting
        - prometheus.label.stack=base
        - prometheus.label.tier=monitoring
        - traefik.enable=true
        - traefik.swarm.network=proxy      
        # Router HTTP
        - traefik.http.routers.alertmanager.rule=Host(`alertmanager.bojemoi.lab`)
        - traefik.http.routers.alertmanager.entrypoints=web
        - traefik.http.routers.alertmanager.middlewares=redirect-to-https
        # Router HTTPS
        - traefik.http.routers.alertmanager-secure.rule=Host(`alertmanager.bojemoi.lab`)
        - traefik.http.routers.alertmanager-secure.entrypoints=websecure
        - traefik.http.routers.alertmanager-secure.tls=true
#       - traefik.http.routers.alertmanager-secure.tls.certresolver=letsencrypt
        # Service
        - traefik.http.services.alertmanager.loadbalancer.server.port=9093
  # =========================================================================
  # =========================================================================

  node-exporter:
    image: localhost:5000/node-exporter:latest
    hostname: "{{.Node.Hostname}}"
    ports:
      - target: 9100
        published: 9100
        protocol: tcp
        mode: host
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs
    command:
      - '--path.procfs=/host/proc'
      - '--path.rootfs=/rootfs'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    networks:
      - monitoring
      - proxy
    deploy:
      mode: global  # Clé importante : déploie une instance sur chaque node
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 64M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      labels:
        - prometheus.enable=true
        - prometheus.port=9100
        - prometheus.path=/metrics
        - prometheus.label.team=infrastructure
        - prometheus.label.component=system-metrics
        - prometheus.label.stack=base
        - prometheus.label.tier=monitoring

  # =============================================================================
  # SERVEUR SMTP PRODUCTION (Postfix)
  # =============================================================================
  postfix:
    image: localhost:5000/postfix:latest
    hostname: mail.bojemoi.lab
    environment:
      # Configuration de base
      - SMTP_SERVER=mail.bojemoi.lab
      - SERVER_HOSTNAME=mail.bojemoi.lab
      
      # Domaines autorisés
      - ALLOWED_SENDER_DOMAINS=bojemoi.lab
      
      # Réseaux autorisés (Docker networks + localhost)
      - SMTP_NETWORKS=127.0.0.0/8 10.0.0.0/8 172.16.0.0/12

      - MYNETWORKS=127.0.0.0/8 10.0.0.0/8 172.16.0.0/12
      
      # Pas de relais externe (local seulement)
      # - RELAYHOST=                    # Laisser vide ou ne pas définir
      # - RELAYHOST_USERNAME=           # Non nécessaire
      # - RELAYHOST_PASSWORD=           # Non nécessaire
      
      # Options supplémentaires utiles
      - SMTP_PORT=25
      - MESSAGE_SIZE_LIMIT=10485760     # 10MB
      - MASQUERADED_DOMAINS=bojemoi.lab
      
      # Logging
      - LOG_SUBJECT=yes                 # Logger les sujets des emails
      # Forcer postfix à logger dans un fichier
      - POSTFIX_LOG_FILE=true
    

    ports:
      - 25:25
    networks:
     - backend
     - monitoring
     - proxy
     - mail
    dns_search:
      - bojemoi.lab

    volumes:
      - postfix_data:/var/spool/postfix
      - postfix_mail:/var/mail
      - postfix_log:/var/log
    configs:
      - source: postfix_config 
        target: /etc/postfix/main.cf
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      labels:
        - traefik.swarm.network=proxy      
        - prometheus.enable=false  # Utilise l'exporter dédié
        - prometheus.label.team=infrastructure
        - prometheus.label.component=mail-server
        - prometheus.label.stack=base
        - prometheus.label.tier=communication
      resources:
        limits:
          memory: 256M

# =============================================================================
# POSTFIX EXPORTER (Métriques Prometheus)
# =============================================================================
  postfix-exporter:
    image: blackflysolutions/postfix-exporter:latest
    hostname: postfix-exporter.bojemoi.lab
    networks:
      - monitoring
      - backend
    dns_search:
      - bojemoi.lab
    environment:
      - POSTFIX_LOGFILE_PATH=/var/log/mail.log
    command:
      - --postfix.showq_path=/var/spool/postfix/public/showq
#      - --postfix.logfile_path=      #/var/log/mail.log
    volumes:
      - postfix_data:/var/spool/postfix:ro
      - postfix_mail:/var/mail:ro
      - postfix_log:/var/log
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == manager  # Même node que Postfix
      labels:
        - prometheus.enable=true
        - prometheus.port=9154
        - prometheus.path=/metrics
        - prometheus.label.team=infrastructure
        - prometheus.label.component=mail-exporter
        - prometheus.label.stack=base
        - prometheus.label.tier=communication
      resources:
        limits:
          memory: 64M
        reservations:
          memory: 32M



# =========================================================================
#    cadvisor
# =========================================================================

  cadvisor:
    image: localhost:5000/cadvisor:latest
    ports:
      - target: 8080
        published: 8088
        protocol: tcp
        mode: host
    volumes:
      - /:/rootfs
      - /var/run:/var/run
      - /sys:/sys
      - /var/lib/docker/:/var/lib/docker
      - /dev/disk/:/dev/disk
    networks:
      - monitoring
      - proxy
    deploy:
      mode: global
      labels:
        - prometheus.enable=true
        - prometheus.port=8080
        - prometheus.path=/metrics
        - prometheus.label.team=infrastructure
        - prometheus.label.component=container-metrics
        - prometheus.label.stack=base
        - prometheus.label.tier=monitoring
        - traefik.enable=true
        - traefik.swarm.network=proxy      
        # Router HTTP
        - traefik.http.routers.cadvisor.rule=Host(`cadvisor.bojemoi.lab`)
        - traefik.http.routers.cadvisor.entrypoints=web
        - traefik.http.routers.cadvisor.middlewares=redirect-to-https
        # Router HTTPS
        - traefik.http.routers.cadvisor-secure.rule=Host(`cadvisor.bojemoi.lab`)
        - traefik.http.routers.cadvisor-secure.entrypoints=websecure
        - traefik.http.routers.cadvisor-secure.tls=true
#        - traefik.http.routers.cadvisor-secure.tls.certresolver=letsencrypt
        # Service
        - traefik.http.services.cadvisor.loadbalancer.server.port=8080
#--------------------------------------------------------------------------------
# for base  images
# -------------------------------------------------------------------------------



  # =========================================================================
  # SERVICE:  rsync 
  # ========================================================================

  rsync-master:
    <<: *mode-template  # H..rite du template de base
    image: localhost:5000/koursk-2:latest
    hostname: rsync-master
    ports:
       - 8084:8080
    deploy:
      <<: *deploy-template  # H..rite du template de d..
      replicas: 1 
      placement:
        constraints:
          - node.role == manager
      labels:
         - prometheus.enable=false
         - prometheus.label.team=infrastructure
         - prometheus.label.component=backup-master
         - prometheus.label.stack=base
         - prometheus.label.tier=backup
    volumes:
       - type: bind
         source: /opt/bojemoi
         target: /opt/bojemoi
       - ssh_keys:/root/.ssh:ro
       - shared_logs:/var/log/rsync
    environment:
       - MODULE=swarm_data
       - DATA_PATH=/opt/bojemoi
       - RSYNC_MODE=master
       - SYNC_INTERVAL=300
       - REMOTE_HOSTS=rsync-slave
       - DOCKER_HOST=tcp://docker-socket-proxy:2375
    networks:
       - monitoring
       - rsync_network
       - backend
    command: ["/scripts/rsync-start.sh"]

  rsync-slave:
    <<: *mode-template  # H..rite du template de base
    hostname: rsync-slave-
    deploy:
      <<: *deploy-template  # H..rite du template de d..
      labels:
          - prometheus.enable=false  # Pas de metrics intégrées
          - prometheus.label.team=infrastructure
          - prometheus.label.component=backup-slave
          - prometheus.label.stack=base
          - prometheus.label.tier=backup
      mode: global
      placement:
        constraints:
          - node.labels.rsync.slave == true
      update_config:
        parallelism: 1
        delay: 10s
    volumes:
      - type: bind
        source: /opt/bojemoi
        target: /opt/bojemoi
      - ssh_keys:/root/.ssh
      - shared_logs:/var/log/rsync
    environment:
      - RSYNC_MODE=slave
      - MASTER_HOST=rsync-master
      - DATA_PATH=/opt/bojemoi
    networks:
      - rsync_network
    command: ["/scripts/rsync-slave.sh"]

#--------------------------------------------------------------------------------
# for base  images
# -------------------------------------------------------------------------------
  postgres-exporter:
    image: localhost:5000/postgres-exporter:latest
    environment:
      DATA_SOURCE_NAME: "postgresql://postgres:bojemoi@postgres:5432/postgres?sslmode=disable"
    networks:
      - monitoring
      - backend
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: '0.5'
          memory: 128M
      labels:
        - prometheus.enable=true
        - prometheus.port=9187
        - prometheus.path=/metrics
        - prometheus.label.team=infrastructure
        - prometheus.label.component=database-exporter
        - prometheus.label.stack=base
        - prometheus.label.tier=data

  # =========================================================================
  # SERVICE: Provisioning Orchestrator
  # =========================================================================
  orchestrator:
    image: localhost:5000/provisioning:latest
    hostname: orchestrator.bojemoi.lab
    command: uvicorn app.main:app --reload --host 0.0.0.0 --port 8000 --app-dir /app
    ports:
      - "28080:8080"
#    configs:
#      - source: provisioning_env
#        target: /app/.env
#        mode: 0440
    volumes:
      # Socket Docker direct requis - l'orchestrator a besoin de POST/DELETE
      # pour créer/supprimer des containers (non supporté par le proxy read-only)
      - /var/run/docker.sock:/var/run/docker.sock
      # Logs persistants
      - provisioning_logs:/app/logs
      # Cache
      - provisioning_cache:/app/cache
    networks:
      - backend
      - proxy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
      labels:
        - "bojemoi.service=orchestrator"
        - "bojemoi.environment=production"
        - prometheus.port=5000
        - prometheus.path=/metrics
        - prometheus.label.team=infrastructure
        - prometheus.label.component=provisioning
        - prometheus.label.stack=base
        - prometheus.label.tier=data

        # Labels Prometheus
        - "prometheus.scrape=true"
        - "prometheus.port=9090"

        # Traefik - Configuration générale
        - "traefik.enable=true"
        - "traefik.docker.network=proxy"

        # Traefik - API HTTP (port 8080)
        - "traefik.http.routers.orchestrator-api.rule=Host(`provisioning.bojemoi.lab`)"
        - "traefik.http.routers.orchestrator-api.entrypoints=websecure"
        - "traefik.http.routers.orchestrator-api.tls=true"
        - "traefik.http.routers.orchestrator-api.tls.certresolver=letsencrypt"
        - "traefik.http.routers.orchestrator-api.service=orchestrator-api"
        - "traefik.http.services.orchestrator-api.loadbalancer.server.port=8080"

        # Traefik - Webhook endpoint avec rate limiting
        - "traefik.http.routers.orchestrator-webhook.rule=Host(`provisioning.bojemoi.lab`) && PathPrefix(`/webhook`)"
        - "traefik.http.routers.orchestrator-webhook.entrypoints=websecure"
        - "traefik.http.routers.orchestrator-webhook.tls=true"
        - "traefik.http.routers.orchestrator-webhook.middlewares=orchestrator-ratelimit"
        - "traefik.http.middlewares.orchestrator-ratelimit.ratelimit.average=10"
        - "traefik.http.middlewares.orchestrator-ratelimit.ratelimit.burst=20"

        # Traefik - Metrics Prometheus
        - "traefik.http.routers.orchestrator-metrics.rule=Host(`provisioning.bojemoi.lab`) && PathPrefix(`/metrics`)"
        - "traefik.http.routers.orchestrator-metrics.entrypoints=websecure"
        - "traefik.http.routers.orchestrator-metrics.tls=true"
        - "traefik.http.routers.orchestrator-metrics.service=orchestrator-metrics"
        - "traefik.http.services.orchestrator-metrics.loadbalancer.server.port=8080"

        # Traefik - Health check
        - "traefik.http.routers.orchestrator-health.rule=Host(`provisioning.bojemoi.lab`) && PathPrefix(`/health`)"
        - "traefik.http.routers.orchestrator-health.entrypoints=websecure"
        - "traefik.http.routers.orchestrator-health.tls=true"

  # =========================================================================
  #    protonmail
  # =========================================================================
  protonmail-bridge:
    image: shenxn/protonmail-bridge:latest
    volumes:
      - protonmail_data:/root
    ports:
      - "1025:25"    # SMTP
      - "1143:143"   # IMAP
    environment:
      - TZ=Europe/Paris
    networks:
      - mail
    deploy:
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
