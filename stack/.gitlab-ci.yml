variables:
  STACK_NAME: "mon-app"
  COMPOSE_FILE: "docker-compose.yml"
  COMPOSE_FILE_PROD: "docker-compose.prod.yml"
  REGISTRY: "registry.bojemoi.lab"
  IMAGE_TAG: "${CI_COMMIT_SHORT_SHA}"

stages:
  - validate
  - build
  - test
  - security
  - deploy
  - verify
  - notify

# Template pour les jobs de d√©ploiement
.deploy_template: &deploy_template
  tags:
    - swarm
    - deploy
  before_script:
    - docker login -u ${CI_REGISTRY_USER} -p ${CI_REGISTRY_PASSWORD} ${REGISTRY}
  after_script:
    - docker logout ${REGISTRY}

# Validation de la syntaxe
validate:syntax:
  stage: validate
  script:
    - docker-compose -f ${COMPOSE_FILE} config --quiet
    - docker-compose -f ${COMPOSE_FILE_PROD} config --quiet
    - echo "‚úÖ Syntaxe valid√©e"
  only:
    - branches

# Validation des variables d'environnement requises
validate:env:
  stage: validate
  script:
    - |
      required_vars=("POSTGRES_PASSWORD" "REDIS_PASSWORD" "API_KEY")
      for var in "${required_vars[@]}"; do
        if [ -z "${!var}" ]; then
          echo "‚ùå Variable manquante: $var"
          exit 1
        fi
      done
    - echo "‚úÖ Variables valid√©es"
  only:
    - main

# Build des images
build:images:
  stage: build
  script:
    - docker-compose -f ${COMPOSE_FILE} build
    - docker-compose -f ${COMPOSE_FILE} push
    - echo "‚úÖ Images construites et push√©es"
  only:
    - main
    - develop

# Tests unitaires
test:unit:
  stage: test
  script:
    - docker-compose -f ${COMPOSE_FILE} run --rm app npm test
    - echo "‚úÖ Tests unitaires pass√©s"
  only:
    - branches

# Tests d'int√©gration
test:integration:
  stage: test
  script:
    - docker-compose -f ${COMPOSE_FILE} up -d
    - sleep 10
    - docker-compose -f ${COMPOSE_FILE} exec -T app npm run test:integration
    - docker-compose -f ${COMPOSE_FILE} down
    - echo "‚úÖ Tests d'int√©gration pass√©s"
  only:
    - main
    - develop

# Scan de vuln√©rabilit√©s avec Trivy
security:trivy:
  stage: security
  script:
    - |
      for image in $(docker-compose -f ${COMPOSE_FILE} config | grep 'image:' | awk '{print $2}'); do
        echo "üîç Scan Trivy: $image"
        docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
          aquasec/trivy image --severity HIGH,CRITICAL --exit-code 1 $image
      done
    - echo "‚úÖ Scan Trivy termin√©"
  only:
    - main
  allow_failure: true

# Scan OWASP ZAP
security:zap:
  stage: security
  script:
    - bash scripts/security/zap-scan.sh
    - echo "‚úÖ Scan ZAP termin√©"
  only:
    - main
  artifacts:
    reports:
      junit: zap-report.xml
    paths:
      - zap-report.html
    expire_in: 1 week
  allow_failure: true

# Upload des r√©sultats vers Faraday
security:faraday:
  stage: security
  script:
    - |
      curl -X POST http://faraday.bojemoi.lab/api/v3/ws/${STACK_NAME}/upload \
        -H "Authorization: Token ${FARADAY_TOKEN}" \
        -F "file=@zap-report.xml"
    - echo "‚úÖ R√©sultats upload√©s vers Faraday"
  dependencies:
    - security:zap
  only:
    - main

# D√©ploiement en staging
deploy:staging:
  <<: *deploy_template
  stage: deploy
  script:
    - bash scripts/deploy.sh ${STACK_NAME}-staging ${COMPOSE_FILE}
    - echo "‚úÖ D√©ploy√© en staging"
  environment:
    name: staging
    url: https://${STACK_NAME}-staging.bojemoi.lab
  only:
    - develop

# D√©ploiement en production
deploy:production:
  <<: *deploy_template
  stage: deploy
  script:
    - bash scripts/deploy.sh ${STACK_NAME} ${COMPOSE_FILE_PROD}
    - echo "‚úÖ D√©ploy√© en production"
  environment:
    name: production
    url: https://${STACK_NAME}.bojemoi.lab
    on_stop: rollback:production
  only:
    - main
  when: manual  # D√©ploiement manuel requis

# Rollback production
rollback:production:
  <<: *deploy_template
  stage: deploy
  script:
    - bash scripts/rollback.sh ${STACK_NAME}
    - echo "üîÑ Rollback effectu√©"
  environment:
    name: production
    action: stop
  only:
    - main
  when: manual

# V√©rification post-d√©ploiement
verify:health:
  stage: verify
  script:
    - bash scripts/health-check.sh ${STACK_NAME}
    - echo "‚úÖ Health check pass√©"
  dependencies:
    - deploy:production
  only:
    - main

# V√©rification Prometheus
verify:prometheus:
  stage: verify
  script:
    - |
      # V√©rifier que les m√©triques remontent
      response=$(curl -s http://prometheus.bojemoi.lab/api/v1/query?query=up{job="${STACK_NAME}"})
      if echo "$response" | grep -q '"value":\[.*,"1"\]'; then
        echo "‚úÖ M√©triques Prometheus OK"
      else
        echo "‚ùå M√©triques Prometheus manquantes"
        exit 1
      fi
  dependencies:
    - deploy:production
  only:
    - main

# Notification Grafana
notify:grafana:
  stage: notify
  script:
    - bash scripts/notify.sh grafana
    - echo "üìä Annotation Grafana cr√©√©e"
  dependencies:
    - deploy:production
  only:
    - main
  when: always

# Notification Slack/Email
notify:team:
  stage: notify
  script:
    - bash scripts/notify.sh team
    - echo "üìß √âquipe notifi√©e"
  only:
    - main
  when: on_success

post_deploy_monitoring:
  stage: deploy
  script:
    - |
      # Notification Grafana
      curl -X POST http://grafana.bojemoi.lab/api/annotations \
        -H "Content-Type: application/json" \
        -d "{\"text\":\"D√©ploiement ${STACK_NAME} - ${CI_COMMIT_SHORT_SHA}\",\"tags\":[\"deployment\",\"${STACK_NAME}\"]}"
  after_script:
    - docker stack ps ${STACK_NAME} --no-trunc

