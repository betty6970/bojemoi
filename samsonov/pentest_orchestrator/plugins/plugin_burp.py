#!/usr/bin/env python3
"""
Plugin Burp Suite pour l'orchestrateur
"""

__description__ = "Plugin pour Burp Suite Professional"
__tool__ = "Burp Suite"
__version__ = "1.0.0"

import requests
import time
import json
from typing import Dict, List

# Configuration par défaut
BURP_API_URL = "http://127.0.0.1:1337"
BURP_API_KEY = "changeme"  # À configurer


def passive_scan(target: str) -> Dict:
    """
    Lance un scan passif avec Burp Suite
    
    Args:
        target: URL cible
    
    Returns:
        Résultats du scan passif
    """
    print(f"[Burp] Passive scan : {target}")
    
    try:
        # Configuration du scan
        scan_config = {
            "urls": [target],
            "scan_configurations": [
                {
                    "name": "Passive Audit",
                    "type": "PassiveScan"
                }
            ]
        }
        
        # Démarre le scan
        response = requests.post(
            f"{BURP_API_URL}/v0.1/scan",
            headers={
                "Content-Type": "application/json"
            },
            json=scan_config,
            timeout=30
        )
        
        if response.status_code == 201:
            location = response.headers.get('Location', '')
            task_id = location.split('/')[-1]
            
            print(f"[Burp] Scan démarré : {task_id}")
            
            # Attend la fin du scan
            while True:
                status_response = requests.get(
                    f"{BURP_API_URL}{location}",
                    timeout=30
                )
                
                status_data = status_response.json()
                scan_status = status_data.get('scan_status', 'unknown')
                
                print(f"[Burp] Status : {scan_status}")
                
                if scan_status in ['succeeded', 'failed']:
                    break
                    
                time.sleep(10)
            
            # Récupère les résultats
            if scan_status == 'succeeded':
                issues = status_data.get('issue_events', [])
                
                severity_count = {'high': 0, 'medium': 0, 'low': 0, 'info': 0}
                for issue in issues:
                    severity = issue.get('issue', {}).get('severity', 'info').lower()
                    severity_count[severity] = severity_count.get(severity, 0) + 1
                
                return {
                    'tool': 'Burp Passive Scan',
                    'target': target,
                    'task_id': task_id,
                    'total_issues': len(issues),
                    'severity_breakdown': severity_count,
                    'issues': issues[:50],  # Limite les résultats
                    'status': 'completed'
                }
            else:
                return {
                    'tool': 'Burp Passive Scan',
                    'target': target,
                    'task_id': task_id,
                    'status': 'failed',
                    'error': 'Scan failed'
                }
        else:
            return {
                'tool': 'Burp Passive Scan',
                'target': target,
                'status': 'error',
                'error': f"HTTP {response.status_code}"
            }
            
    except requests.exceptions.ConnectionError:
        print("[Burp] ERREUR : Burp Suite n'est pas accessible")
        return {
            'tool': 'Burp Passive Scan',
            'target': target,
            'status': 'error',
            'error': 'Burp Suite not reachable'
        }
    except Exception as e:
        return {
            'tool': 'Burp Passive Scan',
            'target': target,
            'status': 'error',
            'error': str(e)
        }


def active_scan(target: str, scan_type: str = "crawl_and_audit") -> Dict:
    """
    Lance un scan actif avec Burp Suite
    
    Args:
        target: URL cible
        scan_type: Type de scan (crawl_and_audit, audit_selected)
    
    Returns:
        Résultats du scan actif
    """
    print(f"[Burp] Active scan : {target}")
    
    try:
        scan_config = {
            "urls": [target],
            "scan_configurations": [
                {
                    "name": "Crawl and Audit - Fast",
                    "type": "NamedConfiguration"
                }
            ],
            "application_logins": [],
            "scope": {
                "include": [{"rule": target}],
                "exclude": []
            }
        }
        
        response = requests.post(
            f"{BURP_API_URL}/v0.1/scan",
            headers={"Content-Type": "application/json"},
            json=scan_config,
            timeout=30
        )
        
        if response.status_code == 201:
            location = response.headers.get('Location', '')
            task_id = location.split('/')[-1]
            
            print(f"[Burp] Scan actif démarré : {task_id}")
            
            # Polling du status
            while True:
                status_response = requests.get(
                    f"{BURP_API_URL}{location}",
                    timeout=30
                )
                
                status_data = status_response.json()
                scan_status = status_data.get('scan_status', 'unknown')
                scan_metrics = status_data.get('scan_metrics', {})
                
                requests_made = scan_metrics.get('requests_made', 0)
                print(f"[Burp] Status : {scan_status} - Requêtes : {requests_made}")
                
                if scan_status in ['succeeded', 'failed']:
                    break
                    
                time.sleep(15)
            
            if scan_status == 'succeeded':
                issues = status_data.get('issue_events', [])
                
                severity_count = {'high': 0, 'medium': 0, 'low': 0, 'info': 0}
                vulnerability_types = {}
                
                for issue in issues:
                    issue_detail = issue.get('issue', {})
                    severity = issue_detail.get('severity', 'info').lower()
                    issue_type = issue_detail.get('type_index', 'unknown')
                    
                    severity_count[severity] = severity_count.get(severity, 0) + 1
                    vulnerability_types[issue_type] = vulnerability_types.get(issue_type, 0) + 1
                
                return {
                    'tool': 'Burp Active Scan',
                    'target': target,
                    'task_id': task_id,
                    'total_issues': len(issues),
                    'severity_breakdown': severity_count,
                    'vulnerability_types': vulnerability_types,
                    'scan_metrics': scan_metrics,
                    'issues': issues[:100],
                    'status': 'completed'
                }
            else:
                return {
                    'tool': 'Burp Active Scan',
                    'target': target,
                    'task_id': task_id,
                    'status': 'failed'
                }
        else:
            return {
                'tool': 'Burp Active Scan',
                'target': target,
                'status': 'error',
                'error': f"HTTP {response.status_code}"
            }
            
    except requests.exceptions.ConnectionError:
        print("[Burp] ERREUR : Burp Suite n'est pas accessible")
        return {
            'tool': 'Burp Active Scan',
            'target': target,
            'status': 'error',
            'error': 'Burp Suite not reachable'
        }
    except Exception as e:
        return {
            'tool': 'Burp Active Scan',
            'target': target,
            'status': 'error',
            'error': str(e)
        }


def get_scan_report(task_id: str, report_format: str = "html") -> Dict:
    """
    Récupère un rapport de scan
    
    Args:
        task_id: ID de la tâche
        report_format: Format du rapport (html, xml)
    
    Returns:
        Chemin du rapport
    """
    print(f"[Burp] Export rapport : {task_id}")
    
    try:
        response = requests.get(
            f"{BURP_API_URL}/v0.1/scan/{task_id}",
            timeout=30
        )
        
        if response.status_code == 200:
            scan_data = response.json()
            
            report_path = f"results/burp_report_{task_id}.json"
            with open(report_path, 'w') as f:
                json.dump(scan_data, f, indent=2)
            
            return {
                'tool': 'Burp Report',
                'task_id': task_id,
                'report_path': report_path,
                'status': 'completed'
            }
        else:
            return {
                'tool': 'Burp Report',
                'task_id': task_id,
                'status': 'error',
                'error': f"HTTP {response.status_code}"
            }
            
    except Exception as e:
        return {
            'tool': 'Burp Report',
            'task_id': task_id,
            'status': 'error',
            'error': str(e)
        }


def get_status() -> Dict:
    """Vérifie le statut de Burp Suite"""
    try:
        response = requests.get(
            f"{BURP_API_URL}/v0.1/scan",
            timeout=5
        )
        
        if response.status_code == 200:
            return {
                'tool': 'Burp Suite',
                'status': 'online',
                'api_url': BURP_API_URL
            }
        else:
            return {
                'tool': 'Burp Suite',
                'status': 'error',
                'error': f"HTTP {response.status_code}"
            }
    except Exception as e:
        return {
            'tool': 'Burp Suite',
            'status': 'offline',
            'error': str(e)
        }

