#!/usr/bin/env python3
"""
Plugin Nuclei pour l'orchestrateur
Scanner de vulnérabilités basé sur des templates
"""

__description__ = "Plugin pour Nuclei vulnerability scanner"
__tool__ = "Nuclei"
__version__ = "1.0.0"

import subprocess
import json
import os
import time
from typing import Dict, List
from pathlib import Path

# Configuration par défaut
NUCLEI_BIN = os.environ.get('NUCLEI_BIN', 'nuclei')
NUCLEI_TEMPLATES = os.environ.get('NUCLEI_TEMPLATES', '/root/nuclei-templates')
RESULTS_DIR = Path("results")


def quick_scan(target: str, severity: str = "critical,high") -> Dict:
    """
    Lance un scan rapide Nuclei (critical + high seulement)

    Args:
        target: URL ou IP cible
        severity: Niveaux de sévérité à scanner

    Returns:
        Résultats du scan
    """
    print(f"[Nuclei] Quick scan : {target}")

    output_file = RESULTS_DIR / f"nuclei_quick_{int(time.time())}.json"
    RESULTS_DIR.mkdir(exist_ok=True)

    try:
        cmd = [
            NUCLEI_BIN,
            '-u', target,
            '-severity', severity,
            '-json-export', str(output_file),
            '-silent',
            '-nc'  # No color
        ]

        result = subprocess.run(
            cmd,
            capture_output=True,
            text=True,
            timeout=600  # 10 minutes timeout
        )

        findings = []
        if output_file.exists():
            with open(output_file, 'r') as f:
                for line in f:
                    if line.strip():
                        try:
                            findings.append(json.loads(line))
                        except json.JSONDecodeError:
                            pass

        severity_count = {'critical': 0, 'high': 0, 'medium': 0, 'low': 0, 'info': 0}
        for finding in findings:
            sev = finding.get('info', {}).get('severity', 'info').lower()
            severity_count[sev] = severity_count.get(sev, 0) + 1

        return {
            'tool': 'Nuclei Quick Scan',
            'target': target,
            'total_findings': len(findings),
            'severity_breakdown': severity_count,
            'findings': findings[:100],  # Limite les résultats
            'output_file': str(output_file),
            'status': 'completed'
        }

    except subprocess.TimeoutExpired:
        return {
            'tool': 'Nuclei Quick Scan',
            'target': target,
            'status': 'error',
            'error': 'Scan timeout (10 min)'
        }
    except FileNotFoundError:
        return {
            'tool': 'Nuclei Quick Scan',
            'target': target,
            'status': 'error',
            'error': f'Nuclei binary not found: {NUCLEI_BIN}'
        }
    except Exception as e:
        return {
            'tool': 'Nuclei Quick Scan',
            'target': target,
            'status': 'error',
            'error': str(e)
        }


def full_scan(target: str, tags: str = None) -> Dict:
    """
    Lance un scan complet Nuclei avec tous les templates

    Args:
        target: URL ou IP cible
        tags: Tags de templates à utiliser (ex: "cve,exposure")

    Returns:
        Résultats du scan
    """
    print(f"[Nuclei] Full scan : {target}")

    output_file = RESULTS_DIR / f"nuclei_full_{int(time.time())}.json"
    RESULTS_DIR.mkdir(exist_ok=True)

    try:
        cmd = [
            NUCLEI_BIN,
            '-u', target,
            '-json-export', str(output_file),
            '-silent',
            '-nc'
        ]

        if tags:
            cmd.extend(['-tags', tags])

        result = subprocess.run(
            cmd,
            capture_output=True,
            text=True,
            timeout=1800  # 30 minutes timeout
        )

        findings = []
        if output_file.exists():
            with open(output_file, 'r') as f:
                for line in f:
                    if line.strip():
                        try:
                            findings.append(json.loads(line))
                        except json.JSONDecodeError:
                            pass

        severity_count = {'critical': 0, 'high': 0, 'medium': 0, 'low': 0, 'info': 0}
        for finding in findings:
            sev = finding.get('info', {}).get('severity', 'info').lower()
            severity_count[sev] = severity_count.get(sev, 0) + 1

        return {
            'tool': 'Nuclei Full Scan',
            'target': target,
            'total_findings': len(findings),
            'severity_breakdown': severity_count,
            'findings': findings,
            'output_file': str(output_file),
            'status': 'completed'
        }

    except subprocess.TimeoutExpired:
        return {
            'tool': 'Nuclei Full Scan',
            'target': target,
            'status': 'error',
            'error': 'Scan timeout (30 min)'
        }
    except Exception as e:
        return {
            'tool': 'Nuclei Full Scan',
            'target': target,
            'status': 'error',
            'error': str(e)
        }


def cve_scan(target: str) -> Dict:
    """
    Scan ciblé sur les CVE connues

    Args:
        target: URL ou IP cible

    Returns:
        Résultats du scan CVE
    """
    print(f"[Nuclei] CVE scan : {target}")

    output_file = RESULTS_DIR / f"nuclei_cve_{int(time.time())}.json"
    RESULTS_DIR.mkdir(exist_ok=True)

    try:
        cmd = [
            NUCLEI_BIN,
            '-u', target,
            '-tags', 'cve',
            '-json-export', str(output_file),
            '-silent',
            '-nc'
        ]

        result = subprocess.run(
            cmd,
            capture_output=True,
            text=True,
            timeout=1200  # 20 minutes timeout
        )

        findings = []
        if output_file.exists():
            with open(output_file, 'r') as f:
                for line in f:
                    if line.strip():
                        try:
                            findings.append(json.loads(line))
                        except json.JSONDecodeError:
                            pass

        # Extract CVE IDs
        cve_ids = []
        for finding in findings:
            template_id = finding.get('template-id', '')
            if template_id.upper().startswith('CVE-'):
                cve_ids.append(template_id.upper())

        return {
            'tool': 'Nuclei CVE Scan',
            'target': target,
            'total_cves': len(cve_ids),
            'cve_ids': list(set(cve_ids)),
            'findings': findings,
            'output_file': str(output_file),
            'status': 'completed'
        }

    except Exception as e:
        return {
            'tool': 'Nuclei CVE Scan',
            'target': target,
            'status': 'error',
            'error': str(e)
        }


def technology_scan(target: str) -> Dict:
    """
    Détection des technologies utilisées

    Args:
        target: URL cible

    Returns:
        Technologies détectées
    """
    print(f"[Nuclei] Technology detection : {target}")

    output_file = RESULTS_DIR / f"nuclei_tech_{int(time.time())}.json"
    RESULTS_DIR.mkdir(exist_ok=True)

    try:
        cmd = [
            NUCLEI_BIN,
            '-u', target,
            '-tags', 'tech',
            '-json-export', str(output_file),
            '-silent',
            '-nc'
        ]

        result = subprocess.run(
            cmd,
            capture_output=True,
            text=True,
            timeout=300  # 5 minutes timeout
        )

        findings = []
        if output_file.exists():
            with open(output_file, 'r') as f:
                for line in f:
                    if line.strip():
                        try:
                            findings.append(json.loads(line))
                        except json.JSONDecodeError:
                            pass

        technologies = []
        for finding in findings:
            tech_name = finding.get('info', {}).get('name', '')
            if tech_name:
                technologies.append(tech_name)

        return {
            'tool': 'Nuclei Tech Detection',
            'target': target,
            'technologies': list(set(technologies)),
            'findings': findings,
            'output_file': str(output_file),
            'status': 'completed'
        }

    except Exception as e:
        return {
            'tool': 'Nuclei Tech Detection',
            'target': target,
            'status': 'error',
            'error': str(e)
        }


def get_status() -> Dict:
    """Vérifie le statut de Nuclei"""
    try:
        result = subprocess.run(
            [NUCLEI_BIN, '-version'],
            capture_output=True,
            text=True,
            timeout=10
        )

        version = result.stdout.strip() or result.stderr.strip()

        return {
            'tool': 'Nuclei',
            'status': 'available',
            'version': version,
            'binary': NUCLEI_BIN
        }
    except FileNotFoundError:
        return {
            'tool': 'Nuclei',
            'status': 'not_installed',
            'error': f'Binary not found: {NUCLEI_BIN}'
        }
    except Exception as e:
        return {
            'tool': 'Nuclei',
            'status': 'error',
            'error': str(e)
        }
