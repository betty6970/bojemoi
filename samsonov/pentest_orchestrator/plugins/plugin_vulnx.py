#!/usr/bin/env python3
"""
Plugin VulnX pour l'orchestrateur
CMS & Web Application Vulnerability Scanner
"""

__description__ = "Plugin pour VulnX CMS vulnerability scanner"
__tool__ = "VulnX"
__version__ = "1.0.0"

import subprocess
import json
import os
import time
import re
from typing import Dict, List
from pathlib import Path

# Configuration par défaut
VULNX_BIN = os.environ.get('VULNX_BIN', 'vulnx')
VULNX_PATH = os.environ.get('VULNX_PATH', '/opt/vulnx')
RESULTS_DIR = Path("results")


def cms_scan(target: str) -> Dict:
    """
    Détecte et scanne le CMS de la cible

    Args:
        target: URL cible

    Returns:
        Résultats du scan CMS
    """
    print(f"[VulnX] CMS scan : {target}")

    output_file = RESULTS_DIR / f"vulnx_cms_{int(time.time())}.json"
    RESULTS_DIR.mkdir(exist_ok=True)

    try:
        cmd = [
            VULNX_BIN,
            '-u', target,
            '--cms',
            '-o', str(output_file.parent),
            '--json'
        ]

        result = subprocess.run(
            cmd,
            capture_output=True,
            text=True,
            timeout=300  # 5 minutes timeout
        )

        output = result.stdout + result.stderr

        # Parse output pour détecter le CMS
        cms_detected = None
        cms_patterns = {
            'wordpress': r'WordPress',
            'joomla': r'Joomla',
            'drupal': r'Drupal',
            'magento': r'Magento',
            'prestashop': r'PrestaShop',
            'opencart': r'OpenCart',
            'typo3': r'TYPO3'
        }

        for cms, pattern in cms_patterns.items():
            if re.search(pattern, output, re.IGNORECASE):
                cms_detected = cms
                break

        return {
            'tool': 'VulnX CMS Scan',
            'target': target,
            'cms_detected': cms_detected,
            'raw_output': output[:5000],  # Limite la sortie
            'status': 'completed'
        }

    except subprocess.TimeoutExpired:
        return {
            'tool': 'VulnX CMS Scan',
            'target': target,
            'status': 'error',
            'error': 'Scan timeout (5 min)'
        }
    except FileNotFoundError:
        return {
            'tool': 'VulnX CMS Scan',
            'target': target,
            'status': 'error',
            'error': f'VulnX binary not found: {VULNX_BIN}'
        }
    except Exception as e:
        return {
            'tool': 'VulnX CMS Scan',
            'target': target,
            'status': 'error',
            'error': str(e)
        }


def full_scan(target: str) -> Dict:
    """
    Lance un scan complet VulnX (CMS + vulnérabilités + exploits)

    Args:
        target: URL cible

    Returns:
        Résultats du scan complet
    """
    print(f"[VulnX] Full scan : {target}")

    RESULTS_DIR.mkdir(exist_ok=True)

    try:
        cmd = [
            VULNX_BIN,
            '-u', target,
            '--full',
            '-D',  # Dork search
            '-w',  # Web info
            '-e'   # Exploit scan
        ]

        result = subprocess.run(
            cmd,
            capture_output=True,
            text=True,
            timeout=600  # 10 minutes timeout
        )

        output = result.stdout + result.stderr

        # Parse les vulnérabilités trouvées
        vulns = []
        vuln_patterns = [
            r'(\[VULN\].*)',
            r'(\[EXPLOIT\].*)',
            r'(\[CRITICAL\].*)',
            r'(\[HIGH\].*)'
        ]

        for pattern in vuln_patterns:
            matches = re.findall(pattern, output, re.IGNORECASE)
            vulns.extend(matches)

        return {
            'tool': 'VulnX Full Scan',
            'target': target,
            'vulnerabilities_found': len(vulns),
            'vulnerabilities': vulns[:50],
            'raw_output': output[:10000],
            'status': 'completed'
        }

    except subprocess.TimeoutExpired:
        return {
            'tool': 'VulnX Full Scan',
            'target': target,
            'status': 'error',
            'error': 'Scan timeout (10 min)'
        }
    except Exception as e:
        return {
            'tool': 'VulnX Full Scan',
            'target': target,
            'status': 'error',
            'error': str(e)
        }


def wordpress_scan(target: str) -> Dict:
    """
    Scan ciblé WordPress

    Args:
        target: URL WordPress cible

    Returns:
        Vulnérabilités WordPress
    """
    print(f"[VulnX] WordPress scan : {target}")

    try:
        cmd = [
            VULNX_BIN,
            '-u', target,
            '--wp',
            '-w',
            '-e'
        ]

        result = subprocess.run(
            cmd,
            capture_output=True,
            text=True,
            timeout=300
        )

        output = result.stdout + result.stderr

        # Parse plugins/themes détectés
        plugins = re.findall(r'plugin[:\s]+([^\s\n]+)', output, re.IGNORECASE)
        themes = re.findall(r'theme[:\s]+([^\s\n]+)', output, re.IGNORECASE)

        return {
            'tool': 'VulnX WordPress Scan',
            'target': target,
            'plugins_detected': list(set(plugins))[:20],
            'themes_detected': list(set(themes))[:10],
            'raw_output': output[:5000],
            'status': 'completed'
        }

    except Exception as e:
        return {
            'tool': 'VulnX WordPress Scan',
            'target': target,
            'status': 'error',
            'error': str(e)
        }


def joomla_scan(target: str) -> Dict:
    """
    Scan ciblé Joomla

    Args:
        target: URL Joomla cible

    Returns:
        Vulnérabilités Joomla
    """
    print(f"[VulnX] Joomla scan : {target}")

    try:
        cmd = [
            VULNX_BIN,
            '-u', target,
            '--joom',
            '-e'
        ]

        result = subprocess.run(
            cmd,
            capture_output=True,
            text=True,
            timeout=300
        )

        output = result.stdout + result.stderr

        # Parse version détectée
        version_match = re.search(r'version[:\s]+([0-9.]+)', output, re.IGNORECASE)
        version = version_match.group(1) if version_match else 'unknown'

        return {
            'tool': 'VulnX Joomla Scan',
            'target': target,
            'joomla_version': version,
            'raw_output': output[:5000],
            'status': 'completed'
        }

    except Exception as e:
        return {
            'tool': 'VulnX Joomla Scan',
            'target': target,
            'status': 'error',
            'error': str(e)
        }


def drupal_scan(target: str) -> Dict:
    """
    Scan ciblé Drupal

    Args:
        target: URL Drupal cible

    Returns:
        Vulnérabilités Drupal
    """
    print(f"[VulnX] Drupal scan : {target}")

    try:
        cmd = [
            VULNX_BIN,
            '-u', target,
            '--drupal',
            '-e'
        ]

        result = subprocess.run(
            cmd,
            capture_output=True,
            text=True,
            timeout=300
        )

        output = result.stdout + result.stderr

        return {
            'tool': 'VulnX Drupal Scan',
            'target': target,
            'raw_output': output[:5000],
            'status': 'completed'
        }

    except Exception as e:
        return {
            'tool': 'VulnX Drupal Scan',
            'target': target,
            'status': 'error',
            'error': str(e)
        }


def subdomain_scan(domain: str) -> Dict:
    """
    Enumération des sous-domaines

    Args:
        domain: Domaine cible

    Returns:
        Liste des sous-domaines
    """
    print(f"[VulnX] Subdomain scan : {domain}")

    try:
        cmd = [
            VULNX_BIN,
            '-u', domain,
            '--sub'
        ]

        result = subprocess.run(
            cmd,
            capture_output=True,
            text=True,
            timeout=300
        )

        output = result.stdout + result.stderr

        # Parse les sous-domaines
        subdomains = re.findall(
            r'([a-zA-Z0-9][-a-zA-Z0-9]*\.' + re.escape(domain) + r')',
            output,
            re.IGNORECASE
        )

        return {
            'tool': 'VulnX Subdomain Scan',
            'domain': domain,
            'subdomains_found': len(set(subdomains)),
            'subdomains': list(set(subdomains))[:100],
            'status': 'completed'
        }

    except Exception as e:
        return {
            'tool': 'VulnX Subdomain Scan',
            'domain': domain,
            'status': 'error',
            'error': str(e)
        }


def get_status() -> Dict:
    """Vérifie le statut de VulnX"""
    try:
        result = subprocess.run(
            [VULNX_BIN, '--help'],
            capture_output=True,
            text=True,
            timeout=10
        )

        return {
            'tool': 'VulnX',
            'status': 'available',
            'binary': VULNX_BIN
        }
    except FileNotFoundError:
        return {
            'tool': 'VulnX',
            'status': 'not_installed',
            'error': f'Binary not found: {VULNX_BIN}'
        }
    except Exception as e:
        return {
            'tool': 'VulnX',
            'status': 'error',
            'error': str(e)
        }
