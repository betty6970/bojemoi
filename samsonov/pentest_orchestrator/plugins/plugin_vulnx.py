#!/usr/bin/env python3
"""
Plugin VulnX pour l'orchestrateur
CMS & Web Application Vulnerability Scanner
Communique avec le daemon VulnX via Redis
"""

__description__ = "Plugin pour VulnX CMS vulnerability scanner"
__tool__ = "VulnX"
__version__ = "2.0.0"

import json
import os
import time
import re
from typing import Dict, List
from pathlib import Path

try:
    import redis
except ImportError:
    redis = None

# Configuration
REDIS_HOST = os.environ.get('REDIS_HOST', 'redis')
REDIS_PORT = int(os.environ.get('REDIS_PORT', 6379))
VULNX_CHANNEL = 'vulnx:commands'
RESULTS_CHANNEL = 'pentest:results'
RESULTS_DIR = Path("results")


def _get_redis():
    """Get Redis connection"""
    if redis is None:
        raise ImportError("redis package not installed")
    return redis.Redis(host=REDIS_HOST, port=REDIS_PORT, decode_responses=True)


def _send_scan_command(target: str, scan_type: str, timeout: int = 120) -> Dict:
    """
    Envoie une commande de scan au daemon VulnX via Redis

    Args:
        target: URL cible
        scan_type: Type de scan (cms, full, wordpress, etc.)
        timeout: Timeout en secondes pour attendre le résultat

    Returns:
        Résultats du scan
    """
    try:
        r = _get_redis()

        # Subscribe to results before sending command
        pubsub = r.pubsub()
        pubsub.subscribe(RESULTS_CHANNEL)

        # Send scan command
        command = json.dumps({
            'target': target,
            'type': scan_type
        })
        r.publish(VULNX_CHANNEL, command)

        # Wait for result
        start_time = time.time()
        while time.time() - start_time < timeout:
            message = pubsub.get_message(timeout=1)
            if message and message['type'] == 'message':
                try:
                    data = json.loads(message['data'])
                    if data.get('tool') == 'vulnx' and data.get('target') == target:
                        pubsub.close()
                        return data
                except json.JSONDecodeError:
                    pass

        pubsub.close()
        return {
            'tool': f'VulnX {scan_type}',
            'target': target,
            'status': 'timeout',
            'error': f'No response from VulnX daemon within {timeout}s'
        }

    except Exception as e:
        return {
            'tool': f'VulnX {scan_type}',
            'target': target,
            'status': 'error',
            'error': str(e)
        }


def cms_scan(target: str) -> Dict:
    """
    Détecte et scanne le CMS de la cible

    Args:
        target: URL cible

    Returns:
        Résultats du scan CMS
    """
    print(f"[VulnX] CMS scan : {target}")
    return _send_scan_command(target, 'cms', timeout=300)


def full_scan(target: str) -> Dict:
    """
    Lance un scan complet VulnX (CMS + vulnérabilités + exploits)

    Args:
        target: URL cible

    Returns:
        Résultats du scan complet
    """
    print(f"[VulnX] Full scan : {target}")
    return _send_scan_command(target, 'full', timeout=600)


def wordpress_scan(target: str) -> Dict:
    """
    Scan ciblé WordPress

    Args:
        target: URL WordPress cible

    Returns:
        Vulnérabilités WordPress
    """
    print(f"[VulnX] WordPress scan : {target}")
    return _send_scan_command(target, 'wordpress', timeout=300)


def joomla_scan(target: str) -> Dict:
    """
    Scan ciblé Joomla

    Args:
        target: URL Joomla cible

    Returns:
        Vulnérabilités Joomla
    """
    print(f"[VulnX] Joomla scan : {target}")
    return _send_scan_command(target, 'joomla', timeout=300)


def drupal_scan(target: str) -> Dict:
    """
    Scan ciblé Drupal

    Args:
        target: URL Drupal cible

    Returns:
        Vulnérabilités Drupal
    """
    print(f"[VulnX] Drupal scan : {target}")
    return _send_scan_command(target, 'drupal', timeout=300)


def subdomain_scan(domain: str) -> Dict:
    """
    Enumération des sous-domaines

    Args:
        domain: Domaine cible

    Returns:
        Liste des sous-domaines
    """
    print(f"[VulnX] Subdomain scan : {domain}")
    return _send_scan_command(domain, 'subdomain', timeout=300)


def get_status() -> Dict:
    """Vérifie le statut du daemon VulnX via Redis"""
    try:
        r = _get_redis()
        # Check if we can connect to Redis
        r.ping()
        return {
            'tool': 'VulnX',
            'status': 'available',
            'mode': 'redis_daemon',
            'channel': VULNX_CHANNEL
        }
    except Exception as e:
        return {
            'tool': 'VulnX',
            'status': 'error',
            'error': str(e)
        }
