#!/usr/bin/env python3
"""
Plugin Masscan pour l'orchestrateur
"""

__description__ = "Plugin pour Masscan - Fast port scanner"
__tool__ = "Masscan"
__version__ = "1.0.0"

import subprocess
import json
import os
from typing import Dict, List
import xml.etree.ElementTree as ET


def quick_scan(target: str, ports: str = "0-1000", rate: int = 10000) -> Dict:
    """
    Scan rapide des ports communs
    
    Args:
        target: Cible (IP ou réseau CIDR)
        ports: Ports à scanner (ex: "80,443" ou "0-1000")
        rate: Vitesse de scan (paquets/sec)
    
    Returns:
        Résultats du scan
    """
    print(f"[Masscan] Quick scan : {target}")
    
    output_file = f"results/masscan_quick_{target.replace('/', '_')}.json"
    
    try:
        cmd = [
            "masscan",
            target,
            "-p", ports,
            "--rate", str(rate),
            "-oJ", output_file,
            "--open"
        ]
        
        print(f"[Masscan] Commande : {' '.join(cmd)}")
        
        # Exécute masscan
        result = subprocess.run(
            cmd,
            capture_output=True,
            text=True,
            timeout=300  # 5 minutes max
        )
        
        if result.returncode == 0:
            # Parse les résultats JSON
            open_ports = []
            if os.path.exists(output_file):
                with open(output_file, 'r') as f:
                    # Masscan génère du JSON line-by-line
                    for line in f:
                        line = line.strip()
                        if line and not line.startswith('#'):
                            try:
                                data = json.loads(line.rstrip(','))
                                if 'ports' in data:
                                    for port_info in data['ports']:
                                        open_ports.append({
                                            'ip': data.get('ip', ''),
                                            'port': port_info.get('port', 0),
                                            'protocol': port_info.get('proto', 'tcp'),
                                            'status': port_info.get('status', 'open')
                                        })
                            except json.JSONDecodeError:
                                continue
            
            # Analyse des résultats
            port_summary = {}
            for port in open_ports:
                port_num = port['port']
                port_summary[port_num] = port_summary.get(port_num, 0) + 1
            
            return {
                'tool': 'Masscan Quick',
                'target': target,
                'ports_scanned': ports,
                'rate': rate,
                'total_open_ports': len(open_ports),
                'unique_ports': len(port_summary),
                'port_summary': port_summary,
                'open_ports': open_ports[:100],  # Limite les résultats
                'output_file': output_file,
                'status': 'completed'
            }
        else:
            error_msg = result.stderr or result.stdout
            return {
                'tool': 'Masscan Quick',
                'target': target,
                'status': 'error',
                'error': error_msg
            }
            
    except subprocess.TimeoutExpired:
        return {
            'tool': 'Masscan Quick',
            'target': target,
            'status': 'error',
            'error': 'Scan timeout (5 minutes)'
        }
    except FileNotFoundError:
        print("[Masscan] ERREUR : Masscan n'est pas installé")
        return {
            'tool': 'Masscan Quick',
            'target': target,
            'status': 'error',
            'error': 'Masscan not installed'
        }
    except Exception as e:
        return {
            'tool': 'Masscan Quick',
            'target': target,
            'status': 'error',
            'error': str(e)
        }


def full_scan(target: str, rate: int = 100000, exclude_ports: str = "") -> Dict:
    """
    Scan complet de tous les ports
    
    Args:
        target: Cible (IP ou réseau CIDR)
        rate: Vitesse de scan (paquets/sec)
        exclude_ports: Ports à exclure
    
    Returns:
        Résultats du scan complet
    """
    print(f"[Masscan] Full scan : {target}")
    
    output_file = f"results/masscan_full_{target.replace('/', '_')}.json"
    
    try:
        cmd = [
            "masscan",
            target,
            "-p", "0-65535",
            "--rate", str(rate),
            "-oJ", output_file,
            "--open"
        ]
        
        if exclude_ports:
            cmd.extend(["--exclude-ports", exclude_ports])
        
        print(f"[Masscan] Commande : {' '.join(cmd)}")
        print("[Masscan] ATTENTION : Scan complet en cours, cela peut prendre du temps...")
        
        result = subprocess.run(
            cmd,
            capture_output=True,
            text=True,
            timeout=3600  # 1 heure max
        )
        
        if result.returncode == 0:
            open_ports = []
            if os.path.exists(output_file):
                with open(output_file, 'r') as f:
                    for line in f:
                        line = line.strip()
                        if line and not line.startswith('#'):
                            try:
                                data = json.loads(line.rstrip(','))
                                if 'ports' in data:
                                    for port_info in data['ports']:
                                        open_ports.append({
                                            'ip': data.get('ip', ''),
                                            'port': port_info.get('port', 0),
                                            'protocol': port_info.get('proto', 'tcp'),
                                            'status': port_info.get('status', 'open')
                                        })
                            except json.JSONDecodeError:
                                continue
            
            # Groupement par service commun
            service_ports = {
                'web': [80, 443, 8080, 8443, 8000, 8888],
                'database': [3306, 5432, 1433, 27017, 6379, 9200],
                'remote': [22, 23, 3389, 5900, 5901],
                'mail': [25, 110, 143, 465, 587, 993, 995],
                'file': [21, 445, 139, 2049, 111]
            }
            
            services_found = {}
            for port in open_ports:
                port_num = port['port']
                for service, ports_list in service_ports.items():
                    if port_num in ports_list:
                        services_found[service] = services_found.get(service, 0) + 1
            
            return {
                'tool': 'Masscan Full',
                'target': target,
                'rate': rate,
                'total_open_ports': len(open_ports),
                'services_found': services_found,
                'open_ports': open_ports,
                'output_file': output_file,
                'status': 'completed'
            }
        else:
            error_msg = result.stderr or result.stdout
            return {
                'tool': 'Masscan Full',
                'target': target,
                'status': 'error',
                'error': error_msg
            }
            
    except subprocess.TimeoutExpired:
        return {
            'tool': 'Masscan Full',
            'target': target,
            'status': 'error',
            'error': 'Scan timeout (1 hour)'
        }
    except FileNotFoundError:
        print("[Masscan] ERREUR : Masscan n'est pas installé")
        return {
            'tool': 'Masscan Full',
            'target': target,
            'status': 'error',
            'error': 'Masscan not installed'
        }
    except Exception as e:
        return {
            'tool': 'Masscan Full',
            'target': target,
            'status': 'error',
            'error': str(e)
        }


def service_scan(target: str, service: str = "web") -> Dict:
    """
    Scan ciblé sur des ports de service spécifiques
    
    Args:
        target: Cible
        service: Type de service (web, database, remote, mail, file)
    
    Returns:
        Résultats du scan
    """
    print(f"[Masscan] Service scan : {service} sur {target}")
    
    service_ports = {
        'web': '80,443,8080,8443,8000,8888,3000,5000',
        'database': '3306,5432,1433,27017,6379,9200,5984,7474',
        'remote': '22,23,3389,5900,5901,5902',
        'mail': '25,110,143,465,587,993,995',
        'file': '21,445,139,2049,111,873',
        'all_common': '21,22,23,25,53,80,110,111,135,139,143,443,445,993,995,1723,3306,3389,5432,5900,8080,8443'
    }
    
    ports = service_ports.get(service, service_ports['all_common'])
    
    return quick_scan(target, ports=ports, rate=50000)


def parse_xml_output(xml_file: str) -> Dict:
    """
    Parse un fichier XML de sortie Masscan
    
    Args:
        xml_file: Chemin du fichier XML
    
    Returns:
        Résultats parsés
    """
    try:
        tree = ET.parse(xml_file)
        root = tree.getroot()
        
        hosts = []
        for host in root.findall('host'):
            host_info = {
                'ip': host.find('address').get('addr'),
                'ports': []
            }
            
            for port in host.findall('.//port'):
                host_info['ports'].append({
                    'port': int(port.get('portid')),
                    'protocol': port.get('protocol'),
                    'state': port.find('state').get('state')
                })
            
            hosts.append(host_info)
        
        return {
            'tool': 'Masscan XML Parser',
            'hosts': hosts,
            'total_hosts': len(hosts)
        }
        
    except Exception as e:
        return {
            'tool': 'Masscan XML Parser',
            'status': 'error',
            'error': str(e)
        }


def get_version() -> Dict:
    """Récupère la version de Masscan"""
    try:
        result = subprocess.run(
            ["masscan", "--version"],
            capture_output=True,
            text=True,
            timeout=5
        )
        
        if result.returncode == 0:
            version = result.stdout.strip()
            return {
                'tool': 'Masscan',
                'status': 'installed',
                'version': version
            }
        else:
            return {
                'tool': 'Masscan',
                'status': 'error',
                'error': result.stderr
            }
    except FileNotFoundError:
        return {
            'tool': 'Masscan',
            'status': 'not_installed',
            'error': 'Masscan not found in PATH'
        }
    except Exception as e:
        return {
            'tool': 'Masscan',
            'status': 'error',
            'error': str(e)
        }

